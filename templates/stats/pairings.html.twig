{% extends 'base.html.twig' %}

{% block title %}Matter Survey - Device Pairings{% endblock %}

{% block header_subtitle %}<p>Discover which devices are commonly used together in smart home setups</p>{% endblock %}

{% block extra_styles %}
    .dashboard-nav {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .dashboard-nav a {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.375rem;
        text-decoration: none;
        color: var(--gray-700);
        font-size: 0.875rem;
    }

    .dashboard-nav a:hover {
        background: var(--gray-100);
    }

    .dashboard-nav a.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .stats-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .stat-card {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
    }

    .stat-card .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .stat-card .label {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .info-box {
        background: var(--blue-100);
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        margin-bottom: 2rem;
        font-size: 0.875rem;
        color: var(--blue-700);
    }

    .info-box strong {
        display: block;
        margin-bottom: 0.25rem;
    }

    .section {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 2rem;
    }

    .section-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .section-header h2 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }

    .section-header p {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin: 0.25rem 0 0;
    }

    .pairing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        padding: 1.25rem;
    }

    .pairing-card {
        padding: 1rem;
        background: var(--gray-50);
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .pairing-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .pairing-count {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: var(--primary);
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .pairing-products {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .pairing-product {
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
        background: white;
        border-radius: 0.25rem;
        text-decoration: none;
        color: inherit;
        transition: box-shadow 0.15s;
    }

    .pairing-product:hover {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .pairing-product-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-900);
    }

    .pairing-product-vendor {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .pairing-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: var(--gray-400);
    }

    .connected-products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        padding: 1.25rem;
    }

    .connected-product-card {
        padding: 1rem;
        background: var(--gray-50);
        border-radius: 0.5rem;
        text-decoration: none;
        color: inherit;
        transition: box-shadow 0.15s;
    }

    .connected-product-card:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .connected-product-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .connected-product-vendor {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
    }

    .connected-product-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
    }

    .connected-stat {
        display: flex;
        gap: 0.25rem;
    }

    .connected-stat-value {
        font-weight: 600;
        color: var(--primary);
    }

    .connected-stat-label {
        color: var(--gray-500);
    }

    .vendor-pairing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        padding: 1.25rem;
    }

    .vendor-pairing-card {
        padding: 1rem;
        background: var(--gray-50);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .vendor-pairing-names {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        min-width: 0;
    }

    .vendor-pairing-name {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--gray-900);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-decoration: none;
    }

    .vendor-pairing-name:hover {
        color: var(--primary);
    }

    .vendor-pairing-separator {
        color: var(--gray-400);
        flex-shrink: 0;
    }

    .vendor-pairing-count {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        background: var(--primary);
        color: white;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1.25rem;
        color: var(--gray-500);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .empty-state-text {
        font-size: 0.875rem;
    }
{% endblock %}

{% block body %}
    <div class="dashboard-nav">
        <a href="{{ path('stats_dashboard') }}">Overview</a>
        <a href="{{ path('stats_clusters') }}">Clusters</a>
        <a href="{{ path('stats_device_types') }}">Device Types</a>
        <a href="{{ path('stats_binding') }}">Binding</a>
        <a href="{{ path('stats_versions') }}">Versions</a>
        <a href="{{ path('stats_pairings') }}" class="active">Pairings</a>
        <a href="{{ path('device_index') }}">Browse Devices</a>
        <a href="{{ path('vendor_index') }}">Vendors</a>
    </div>

    <div class="info-box">
        <strong>About Device Pairings</strong>
        This page shows which Matter devices are commonly found together in the same smart home installation.
        This data is based on anonymous telemetry submissions and helps you discover popular device combinations.
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="value">{{ pairingStats.total_installations|number_format }}</div>
            <div class="label">Tracked Installations</div>
        </div>
        <div class="stat-card">
            <div class="value">{{ pairingStats.avg_products_per_installation }}</div>
            <div class="label">Avg Products per Install</div>
        </div>
        <div class="stat-card">
            <div class="value">{{ pairingStats.total_pairings|number_format }}</div>
            <div class="label">Unique Product Pairings</div>
        </div>
        <div class="stat-card">
            <div class="value">{{ stats.total_devices|number_format }}</div>
            <div class="label">Total Products</div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Top Product Pairings</h2>
            <p>Products most frequently found together in the same installation</p>
        </div>
        {% if topPairings is not empty %}
            <div class="pairing-grid">
                {% for pairing in topPairings %}
                    <div class="pairing-card">
                        <div class="pairing-card-header">
                            <span class="pairing-count">{{ pairing.shared_installations }} shared</span>
                        </div>
                        <div class="pairing-products">
                            <a href="{{ path('device_show', {slug: pairing.product_a_slug}) }}" class="pairing-product">
                                <span class="pairing-product-name">{{ pairing.product_a_name ?? 'Unknown' }}</span>
                                <span class="pairing-product-vendor">{{ pairing.product_a_vendor ?? 'Unknown' }}</span>
                            </a>
                            <div class="pairing-divider">+</div>
                            <a href="{{ path('device_show', {slug: pairing.product_b_slug}) }}" class="pairing-product">
                                <span class="pairing-product-name">{{ pairing.product_b_name ?? 'Unknown' }}</span>
                                <span class="pairing-product-vendor">{{ pairing.product_b_vendor ?? 'Unknown' }}</span>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üîó</div>
                <div class="empty-state-text">
                    No product pairings found yet.<br>
                    Pairings will appear as more installations submit telemetry data.
                </div>
            </div>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Most Connected Products</h2>
            <p>Products that appear with the widest variety of other devices</p>
        </div>
        {% if mostConnectedProducts is not empty %}
            <div class="connected-products-grid">
                {% for product in mostConnectedProducts %}
                    <a href="{{ path('device_show', {slug: product.slug}) }}" class="connected-product-card">
                        <div class="connected-product-name">{{ product.product_name ?? 'Unknown' }}</div>
                        <div class="connected-product-vendor">{{ product.vendor_name ?? 'Unknown' }}</div>
                        <div class="connected-product-stats">
                            <span class="connected-stat">
                                <span class="connected-stat-value">{{ product.unique_pairings }}</span>
                                <span class="connected-stat-label">paired products</span>
                            </span>
                            <span class="connected-stat">
                                <span class="connected-stat-value">{{ product.installation_count }}</span>
                                <span class="connected-stat-label">installations</span>
                            </span>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üè†</div>
                <div class="empty-state-text">
                    No hub products identified yet.
                </div>
            </div>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Vendor Pairings</h2>
            <p>Which vendors' products are commonly used together</p>
        </div>
        {% if vendorPairings is not empty %}
            <div class="vendor-pairing-grid">
                {% for pairing in vendorPairings %}
                    <div class="vendor-pairing-card">
                        <div class="vendor-pairing-names">
                            <a href="{{ path('vendor_show', {slug: pairing.vendor_a_slug}) }}" class="vendor-pairing-name">{{ pairing.vendor_a }}</a>
                            <span class="vendor-pairing-separator">+</span>
                            <a href="{{ path('vendor_show', {slug: pairing.vendor_b_slug}) }}" class="vendor-pairing-name">{{ pairing.vendor_b }}</a>
                        </div>
                        <span class="vendor-pairing-count">{{ pairing.shared_installations }}</span>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üè¢</div>
                <div class="empty-state-text">
                    No vendor pairings found yet.
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
