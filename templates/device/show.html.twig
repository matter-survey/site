{% extends 'base.html.twig' %}

{% from 'components/_star_rating.html.twig' import stars, starsCompact, starsBadge %}

{# Macro for rendering cluster tag with tooltip showing spec info or actual telemetry data #}
{% macro clusterTag(clusterId, matterRegistry, isClient, clusterDetails) %}
    {% set meta = matterRegistry.getClusterMetadata(clusterId) %}
    {% set desc = meta.description ?? '' %}
    {% set isProprietary = matterRegistry.isProprietaryCluster(clusterId) %}
    {# Find matching cluster details from v3 telemetry if available #}
    {% set actualDetails = null %}
    {% if clusterDetails %}
        {% for detail in clusterDetails %}
            {% if detail.id == clusterId %}
                {% set actualDetails = detail %}
            {% endif %}
        {% endfor %}
    {% endif %}
    {% set hasActualData = actualDetails is not null and (actualDetails.feature_map is defined or actualDetails.attribute_list is defined or actualDetails.accepted_command_list is defined) %}
    <span class="cluster-tooltip">
        <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(clusterId)}) }}" class="tag{{ isClient ? ' tag-client' : '' }}{{ isProprietary ? ' tag-proprietary' : '' }}{{ hasActualData ? ' tag-has-details' : '' }}">
            {{ meta.name ?? ('Cluster ' ~ clusterId) }}
            {% if hasActualData %}<span style="font-size: 0.625rem; opacity: 0.7;">‚úì</span>{% endif %}
        </a>
        <span class="cluster-details">
            <h5>{{ meta.name ?? ('Cluster ' ~ clusterId) }}</h5>
            {% if hasActualData %}
                {# Show actual telemetry data #}
                {% if actualDetails.feature_map is defined and actualDetails.feature_map > 0 %}
                    <div class="cluster-details-section">
                        <div class="cluster-details-label">Feature Map</div>
                        <div class="cluster-details-list">
                            <span class="cluster-attr">0x{{ '%X'|format(actualDetails.feature_map) }}</span>
                        </div>
                    </div>
                {% endif %}
                {% if actualDetails.accepted_command_list is defined and actualDetails.accepted_command_list|length > 0 %}
                    <div class="cluster-details-section">
                        <div class="cluster-details-label">Accepts Commands ({{ actualDetails.accepted_command_list|length }})</div>
                        <div class="cluster-details-list">
                            {% for cmdId in actualDetails.accepted_command_list|slice(0, 8) %}
                                {% set cmdName = matterRegistry.getClusterCommandName(clusterId, cmdId) %}
                                <span class="cluster-attr" title="Command ID {{ cmdId }}">{{ cmdName ?? cmdId }}</span>
                            {% endfor %}
                            {% if actualDetails.accepted_command_list|length > 8 %}
                                <span class="cluster-attr">+{{ actualDetails.accepted_command_list|length - 8 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                {% if actualDetails.generated_command_list is defined and actualDetails.generated_command_list|length > 0 %}
                    <div class="cluster-details-section">
                        <div class="cluster-details-label">Generates Commands ({{ actualDetails.generated_command_list|length }})</div>
                        <div class="cluster-details-list">
                            {% for cmdId in actualDetails.generated_command_list|slice(0, 8) %}
                                {% set cmdName = matterRegistry.getClusterCommandName(clusterId, cmdId) %}
                                <span class="cluster-attr" title="Command ID {{ cmdId }}">{{ cmdName ?? cmdId }}</span>
                            {% endfor %}
                            {% if actualDetails.generated_command_list|length > 8 %}
                                <span class="cluster-attr">+{{ actualDetails.generated_command_list|length - 8 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                {% if actualDetails.attribute_list is defined and actualDetails.attribute_list|length > 0 %}
                    <div class="cluster-details-section">
                        <div class="cluster-details-label">Attributes ({{ actualDetails.attribute_list|length }})</div>
                        <div class="cluster-details-list">
                            {% for attrId in actualDetails.attribute_list|slice(0, 10) %}
                                {% if attrId < 65528 %}{# Skip global attributes #}
                                    {% set attrName = matterRegistry.getClusterAttributeName(clusterId, attrId) %}
                                    <span class="cluster-attr" title="Attribute ID {{ attrId }}">{{ attrName ?? attrId }}</span>
                                {% endif %}
                            {% endfor %}
                            {% set nonGlobalAttrs = actualDetails.attribute_list|filter(a => a < 65528) %}
                            {% if nonGlobalAttrs|length > 10 %}
                                <span class="cluster-attr">+{{ nonGlobalAttrs|length - 10 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                <p style="margin: 0.5rem 0 0; font-size: 0.625rem; opacity: 0.6; color: #86efac;">‚úì Actual device capabilities from telemetry</p>
            {% elseif desc %}
                {# Fallback to spec description #}
                <p style="margin: 0; opacity: 0.9; font-size: 0.6875rem;">{{ desc|length > 200 ? desc|slice(0, 200) ~ '...' : desc }}</p>
                <p style="margin: 0.5rem 0 0; font-size: 0.625rem; opacity: 0.6;">Click for full spec details</p>
            {% endif %}
        </span>
    </span>
{% endmacro %}

{# Macro for device type icons using Unicode symbols #}
{% macro deviceIcon(icon) %}
    {%- set icons = {
        'lightbulb': 'üí°',
        'lock': 'üîí',
        'thermometer': 'üå°Ô∏è',
        'fan': 'üåÄ',
        'plug': 'üîå',
        'tv': 'üì∫',
        'speaker': 'üîä',
        'volume-up': 'üîä',
        'door-open': 'üö™',
        'droplet': 'üíß',
        'water': 'üíß',
        'snowflake': '‚ùÑÔ∏è',
        'fire': 'üî•',
        'sun': '‚òÄÔ∏è',
        'wind': 'üí®',
        'leaf': 'üåø',
        'bolt': '‚ö°',
        'battery': 'üîã',
        'battery-full': 'üîã',
        'solar-panel': '‚òÄÔ∏è',
        'charging-station': 'üîå',
        'server': 'üñ•Ô∏è',
        'hub': 'üéõÔ∏è',
        'bridge': 'üåâ',
        'router': 'üì°',
        'network-wired': 'üåê',
        'toggle-on': 'üîò',
        'sliders': 'üéöÔ∏è',
        'palette': 'üé®',
        'blinds': 'ü™ü',
        'gauge': 'üìä',
        'bell': 'üîî',
        'motion-sensor': 'üëÅÔ∏è',
        'robot': 'ü§ñ',
        'washing-machine': 'üß∫',
        'microwave': 'üì¶',
        'utensils': 'üçΩÔ∏è',
        'box': 'üì¶',
        'faucet': 'üö∞',
        'cloud-rain': 'üåßÔ∏è',
        'play-circle': '‚ñ∂Ô∏è',
        'cast': 'üì≤',
        'remote': 'üéÆ',
        'download': '‚¨áÔ∏è',
        'upload': '‚¨ÜÔ∏è',
        'device': 'üì±'
    } -%}
    {{- icons[icon] ?? 'üì±' -}}
{% endmacro %}

{% block title %}{{ device.product_name ?? 'Unknown Device' }} - Matter Survey{% endblock %}

{% block og_title %}{{ device.product_name ?? 'Unknown Device' }} by {{ device.vendor_name ?? 'Unknown Vendor' }}{% endblock %}
{% block og_description %}Matter smart home device: {{ device.product_name ?? 'Unknown Device' }} from {{ device.vendor_name ?? 'Unknown Vendor' }}. Vendor ID: {{ device.vendor_id }}, Product ID: {{ device.product_id }}. View device capabilities, endpoints, and compatible devices.{% endblock %}
{% block og_type %}product{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Product",
    "name": {{ (device.product_name ?? 'Unknown Device')|json_encode|raw }},
    "description": {{ ("Matter smart home device with " ~ (endpoints|length) ~ " endpoint(s)")|json_encode|raw }},
    "productID": "{{ device.vendor_id }}:{{ device.product_id }}",
    "sku": "{{ device.vendor_id }}-{{ device.product_id }}",
    "category": "Smart Home Device",
    "manufacturer": {
        "@type": "Organization",
        "name": {{ (device.vendor_name ?? 'Unknown Vendor')|json_encode|raw }}
        {%- if device.vendor_slug %},
        "url": "{{ url('vendor_show', {slug: device.vendor_slug}) }}"
        {%- endif %}

    },
    "additionalProperty": [
        {
            "@type": "PropertyValue",
            "name": "Vendor ID",
            "value": "{{ device.vendor_id }}"
        },
        {
            "@type": "PropertyValue",
            "name": "Product ID",
            "value": "{{ device.product_id }}"
        },
        {
            "@type": "PropertyValue",
            "name": "Supports Binding",
            "value": "{{ device.supports_binding ? 'Yes' : 'No' }}"
        }
    ]
}
</script>
{% endblock %}

{% block header_subtitle %}{% endblock %}

{% block extra_styles %}
    .breadcrumb {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
    }

    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }

    .device-header {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .device-header-title {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .device-header h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .device-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .compliance-notice {
        font-size: 0.75rem;
        color: #b91c1c;
        background: #fef2f2;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    /* Star rating styles */
    .star-rating {
        font-size: 1.25rem;
        display: inline-flex;
        align-items: center;
        gap: 0.125rem;
    }

    .star-rating .star-filled { color: #f59e0b; }
    .star-rating .star-empty { color: #d1d5db; }

    /* Half star styling */
    .star-rating .star-half {
        position: relative;
        display: inline-block;
    }
    .star-rating .star-half .star-half-filled {
        color: #f59e0b;
        position: absolute;
        overflow: hidden;
        width: 50%;
    }
    .star-rating .star-half .star-half-empty {
        color: #d1d5db;
    }

    .star-rating .score-value {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-left: 0.5rem;
    }

    .star-rating-noncompliant .star-filled { color: #9ca3af; }
    .star-rating-noncompliant .star-half .star-half-filled { color: #9ca3af; }

    .star-rating-compact {
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        background: #fef3c7;
        color: #92400e;
    }

    /* Compact rating colors (rating * 10) */
    .star-rating-50.star-rating-compact { background: #dcfce7; color: #166534; }
    .star-rating-45.star-rating-compact { background: #d1fae5; color: #166534; }
    .star-rating-40.star-rating-compact { background: #dbeafe; color: #1e40af; }
    .star-rating-35.star-rating-compact { background: #e0f2fe; color: #1e40af; }
    .star-rating-30.star-rating-compact { background: #fef3c7; color: #92400e; }
    .star-rating-25.star-rating-compact { background: #fef9c3; color: #92400e; }
    .star-rating-20.star-rating-compact { background: #fee2e2; color: #991b1b; }
    .star-rating-15.star-rating-compact { background: #fee2e2; color: #991b1b; }
    .star-rating-10.star-rating-compact { background: #fee2e2; color: #991b1b; }
    .star-rating-5.star-rating-compact { background: #fee2e2; color: #991b1b; }

    /* Badge rating for list pages (rating * 10) */
    .badge-rating {
        font-weight: 600;
    }

    .badge-rating-50 { background: #dcfce7; color: #166534; }
    .badge-rating-45 { background: #d1fae5; color: #166534; }
    .badge-rating-40 { background: #dbeafe; color: #1e40af; }
    .badge-rating-35 { background: #e0f2fe; color: #1e40af; }
    .badge-rating-30 { background: #fef3c7; color: #92400e; }
    .badge-rating-25 { background: #fef9c3; color: #92400e; }
    .badge-rating-20 { background: #fee2e2; color: #991b1b; }
    .badge-rating-15 { background: #fee2e2; color: #991b1b; }
    .badge-rating-10 { background: #fee2e2; color: #991b1b; }
    .badge-rating-5 { background: #fee2e2; color: #991b1b; }

    .badge-rating-noncompliant {
        position: relative;
    }

    .badge-rating .compliance-warning {
        margin-left: 0.25rem;
        color: #dc2626;
        font-weight: bold;
    }

    .device-header .vendor {
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .device-ids {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .device-id {
        font-size: 0.875rem;
    }

    .device-id .label {
        color: var(--gray-500);
    }

    .device-id .value {
        font-family: monospace;
        background: var(--gray-100);
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
    }

    .badge-ble { background: #dbeafe; color: #1d4ed8; }
    .badge-softap { background: #fef3c7; color: #92400e; }
    .badge-network { background: #d1fae5; color: #065f46; }

    .section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .section h3 {
        font-size: 1.125rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .endpoint {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .endpoint:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .version-group {
        margin-bottom: 1.5rem;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
    }

    .version-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
    }

    .version-label {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    .endpoint-count {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .version-group .endpoint {
        margin: 0;
        padding: 1rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .version-group .endpoint:last-child {
        border-bottom: none;
    }

    .version-diff {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--gray-50);
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }

    .version-diff .diff-title {
        font-weight: 600;
        color: var(--gray-600);
        margin-bottom: 0.25rem;
    }

    .diff-added {
        color: #166534;
    }

    .diff-removed {
        color: #991b1b;
    }

    .diff-added::before {
        content: "+ ";
        font-weight: 600;
    }

    .diff-removed::before {
        content: "‚àí ";
        font-weight: 600;
    }

    .diff-item {
        display: inline-block;
        margin-right: 0.5rem;
    }

    .endpoint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .endpoint-header h4 {
        font-size: 1rem;
        font-weight: 600;
    }

    .device-types, .clusters {
        margin-bottom: 0.75rem;
    }

    .device-types .label, .clusters .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.25rem;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: var(--gray-100);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        position: relative;
        text-decoration: none;
        color: inherit;
        transition: opacity 0.15s;
    }

    a.tag {
        cursor: pointer;
    }

    a.tag:hover {
        opacity: 0.8;
    }

    .tag[title] {
        position: relative;
    }

    .tag[title]:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 1rem;
        border: 6px solid transparent;
        border-top-color: #1f2937;
        z-index: 10000;
    }

    .tag[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: calc(100% + 10px);
        left: 0;
        background: #1f2937;
        color: #ffffff;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        z-index: 9999;
        width: max-content;
        max-width: 400px;
        white-space: normal;
        text-align: left;
        line-height: 1.5;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        pointer-events: none;
    }

    .tag-primary {
        background: var(--blue-100);
        color: var(--blue-700);
    }

    .tag-client {
        background: #dbeafe;
        color: #1e40af;
        border: 1px dashed #93c5fd;
    }

    .tag-proprietary {
        background: #faf5ff;
        color: #7c3aed;
        border: 1px dashed #c4b5fd;
    }

    .tag-has-details {
        background: #dcfce7;
        border: 1px solid #86efac;
    }

    /* Category-based colors */
    .tag-category-lights {
        background: #fef3c7;
        color: #92400e;
    }

    .tag-category-climate {
        background: #dbeafe;
        color: #1e40af;
    }

    .tag-category-sensors {
        background: #d1fae5;
        color: #065f46;
    }

    .tag-category-security {
        background: #fee2e2;
        color: #991b1b;
    }

    .tag-category-appliances {
        background: #f3e8ff;
        color: #6b21a8;
    }

    .tag-category-entertainment {
        background: #fce7f3;
        color: #9d174d;
    }

    .tag-category-energy {
        background: #ecfccb;
        color: #3f6212;
    }

    .tag-category-system {
        background: var(--gray-200);
        color: var(--gray-700);
    }

    .tag .device-icon {
        font-size: 0.875rem;
        opacity: 0.8;
    }

    .spec-badge {
        display: inline-block;
        padding: 0.0625rem 0.25rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0.1875rem;
        font-size: 0.625rem;
        font-weight: 600;
        margin-left: 0.125rem;
    }

    .tag-id {
        opacity: 0.6;
        font-size: 0.75rem;
    }

    .versions-table {
        width: 100%;
        border-collapse: collapse;
    }

    .versions-table th, .versions-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-200);
    }

    .versions-table th {
        font-weight: 600;
        color: var(--gray-500);
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .back-link {
        margin-bottom: 1rem;
    }

    .back-link a {
        color: var(--primary);
        text-decoration: none;
    }

    .compatibility-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .compatibility-section h3 {
        font-size: 1.125rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .compatibility-group {
        margin-bottom: 1.25rem;
    }

    .compatibility-group:last-child {
        margin-bottom: 0;
    }

    .compatibility-group h4 {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .compatibility-group h4 .cluster-name {
        color: var(--gray-900);
        font-weight: 600;
    }

    .compatible-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .compatible-device {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: var(--gray-100);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        text-decoration: none;
        color: var(--gray-700);
        transition: background 0.15s, color 0.15s;
    }

    .compatible-device:hover {
        background: var(--primary);
        color: white;
    }

    .more-devices {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.8125rem;
        color: var(--gray-500);
    }

    .pairing-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .pairing-section h3 {
        font-size: 1.125rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .pairing-subtitle {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .paired-products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 0.75rem;
    }

    .paired-product {
        display: flex;
        flex-direction: column;
        padding: 0.75rem;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 0.375rem;
        text-decoration: none;
        color: inherit;
        transition: border-color 0.15s, box-shadow 0.15s;
    }

    .paired-product:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .paired-product-name {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
        color: var(--gray-900);
    }

    .paired-product-vendor {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
    }

    .pairing-stats {
        display: flex;
        gap: 0.75rem;
        font-size: 0.75rem;
    }

    .pairing-stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .pairing-stat-value {
        font-weight: 600;
        color: var(--primary);
    }

    .pairing-stat-label {
        color: var(--gray-500);
    }

    .pairing-strength-bar {
        width: 100%;
        height: 4px;
        background: var(--gray-200);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .pairing-strength-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 2px;
    }

    .installation-stat {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: var(--blue-50);
        border: 1px solid var(--blue-200);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        color: var(--blue-700);
        margin-left: 0.5rem;
    }

    .gap-analysis-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .gap-analysis-section h3 {
        font-size: 1.125rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .gap-analysis-subtitle {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .device-type-analysis {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: 0.5rem;
    }

    .device-type-analysis:last-child {
        margin-bottom: 0;
    }

    .device-type-analysis-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .device-type-analysis-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--gray-900);
    }

    .compliance-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .compliance-badge-success {
        background: var(--green-100);
        color: var(--green-700);
    }

    .compliance-badge-warning {
        background: var(--yellow-100);
        color: var(--yellow-700);
    }

    .compliance-badge-error {
        background: var(--red-100);
        color: var(--red-700);
    }

    .compliance-score {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .compliance-score-bar {
        flex: 1;
        height: 8px;
        background: var(--gray-200);
        border-radius: 4px;
        overflow: hidden;
    }

    .compliance-score-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s;
    }

    .compliance-score-fill-high {
        background: var(--green-500);
    }

    .compliance-score-fill-medium {
        background: var(--yellow-500);
    }

    .compliance-score-fill-low {
        background: var(--red-500);
    }

    .compliance-score-value {
        font-weight: 600;
        font-size: 0.875rem;
        min-width: 3rem;
        text-align: right;
    }

    .type-star-rating {
        margin-right: 0.75rem;
    }

    .client-bonus-indicator {
        font-size: 0.75rem;
        color: #166534;
        background: #dcfce7;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
    }

    .gap-clusters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .gap-cluster-group {
        padding: 0.75rem;
        background: white;
        border-radius: 0.375rem;
        border: 1px solid var(--gray-200);
    }

    .gap-cluster-group-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .gap-cluster-group-title .count {
        background: var(--gray-200);
        padding: 0.125rem 0.375rem;
        border-radius: 9999px;
        font-size: 0.625rem;
    }

    .gap-cluster-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .gap-cluster-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        text-decoration: none;
    }

    .gap-cluster-missing-mandatory {
        background: var(--red-100);
        color: var(--red-700);
        border: 1px solid var(--red-200);
    }

    .gap-cluster-missing-optional {
        background: var(--gray-100);
        color: var(--gray-600);
        border: 1px dashed var(--gray-300);
    }

    .gap-cluster-implemented {
        background: var(--green-100);
        color: var(--green-700);
        border: 1px solid var(--green-200);
    }

    .gap-cluster-extra {
        background: var(--blue-100);
        color: var(--blue-700);
        border: 1px solid var(--blue-200);
    }

    .gap-empty {
        font-size: 0.8125rem;
        color: var(--gray-400);
        font-style: italic;
    }

    .product-link {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin-right: 0.5rem;
        background: var(--gray-100);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        text-decoration: none;
        color: var(--gray-700);
        transition: background 0.15s, color 0.15s;
    }

    .product-link:hover {
        background: var(--primary);
        color: white;
    }

    .cluster-tooltip {
        position: relative;
        cursor: help;
    }

    .cluster-details {
        display: none;
        position: absolute;
        bottom: calc(100% + 8px);
        left: 0;
        min-width: 280px;
        max-width: 400px;
        background: #1f2937;
        color: #fff;
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .cluster-tooltip:hover .cluster-details {
        display: block;
    }

    .cluster-details h5 {
        margin: 0 0 0.5rem;
        font-size: 0.8125rem;
        color: #fff;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 0.25rem;
    }

    .cluster-details-section {
        margin-bottom: 0.5rem;
    }

    .cluster-details-section:last-child {
        margin-bottom: 0;
    }

    .cluster-details-label {
        font-weight: 600;
        color: rgba(255,255,255,0.7);
        font-size: 0.625rem;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }

    .cluster-details-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .cluster-attr {
        display: inline-block;
        padding: 0.125rem 0.375rem;
        background: rgba(255,255,255,0.1);
        border-radius: 0.25rem;
        font-size: 0.6875rem;
    }

    /* Commissioning hint badges */
    .hint-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.6875rem;
        font-weight: 500;
        margin-right: 0.25rem;
    }

    .hint-standard { background: #dcfce7; color: #166534; }
    .hint-power { background: #fef3c7; color: #92400e; }
    .hint-manual { background: #dbeafe; color: #1e40af; }
    .hint-reset { background: #fee2e2; color: #991b1b; }
    .hint-custom { background: #f3e8ff; color: #7c3aed; }

    .setup-complexity {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .setup-complexity-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-500);
    }

    /* Capabilities Section */
    .capabilities-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .capabilities-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--gray-200);
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .capabilities-title h3 {
        font-size: 1.125rem;
        margin: 0 0 0.25rem;
    }

    .device-category-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        background: var(--gray-100);
        border-radius: 9999px;
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .capabilities-summary {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .capabilities-rating {
        font-size: 1.125rem;
    }

    .capabilities-rating .star-filled { color: #f59e0b; }
    .capabilities-rating .star-empty { color: #d1d5db; }
    .capabilities-rating .star-half {
        position: relative;
        display: inline-block;
    }
    .capabilities-rating .star-half .star-half-filled {
        color: #f59e0b;
        position: absolute;
        overflow: hidden;
        width: 50%;
    }
    .capabilities-rating .star-half .star-half-empty {
        color: #d1d5db;
    }

    .capabilities-percentage {
        font-size: 0.875rem;
        color: var(--gray-500);
        background: var(--gray-100);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    .capabilities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
    }

    .capability-category {
        min-width: 0;
    }

    .category-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--gray-500);
        margin: 0 0 0.5rem;
        letter-spacing: 0.025em;
    }

    .capability-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .capability-card {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.625rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        cursor: default;
        transition: transform 0.1s;
    }

    .capability-card:hover {
        transform: translateY(-1px);
    }

    .capability-supported {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .capability-unsupported {
        background: var(--gray-100);
        color: var(--gray-400);
        border: 1px solid var(--gray-200);
    }

    .capability-emoji {
        font-size: 1rem;
    }

    .capability-label {
        font-weight: 500;
    }

    .capability-status {
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: auto;
    }

    .capability-supported .capability-status {
        color: #166534;
    }

    .capability-unsupported .capability-status {
        color: var(--gray-400);
    }

    .capabilities-callouts {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-100);
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .callout {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
    }

    .callout-standout {
        background: #fef3c7;
        color: #92400e;
    }

    .callout-missing {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    .callout-icon {
        font-size: 0.875rem;
    }

    .callout-label {
        font-weight: 600;
    }

    /* Collapsible Sections */
    .collapsible-section {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .collapsible-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        cursor: pointer;
        user-select: none;
        background: var(--gray-50);
        border-bottom: 1px solid transparent;
        transition: background 0.15s;
    }

    .collapsible-header:hover {
        background: var(--gray-100);
    }

    .collapsible-header h3 {
        font-size: 1rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .collapsible-header .section-badge {
        font-size: 0.6875rem;
        padding: 0.125rem 0.375rem;
        background: var(--gray-200);
        border-radius: 9999px;
        color: var(--gray-600);
        font-weight: 500;
    }

    .collapsible-toggle {
        font-size: 0.875rem;
        color: var(--gray-400);
        transition: transform 0.2s;
    }

    .collapsible-section.open .collapsible-toggle {
        transform: rotate(180deg);
    }

    .collapsible-section.open .collapsible-header {
        border-bottom-color: var(--gray-200);
    }

    .collapsible-content {
        display: none;
        padding: 1.25rem;
    }

    .collapsible-section.open .collapsible-content {
        display: block;
    }

    /* Remove margin/padding from nested sections in collapsibles */
    .collapsible-content > .section,
    .collapsible-content > .compatibility-section,
    .collapsible-content > .gap-analysis-section,
    .collapsible-content > .pairing-section {
        margin-bottom: 0;
        border: none;
        border-radius: 0;
        padding: 0;
    }

    .collapsible-content > .section h3,
    .collapsible-content > .compatibility-section h3,
    .collapsible-content > .gap-analysis-section h3,
    .collapsible-content > .pairing-section h3 {
        display: none;
    }
{% endblock %}

{% block body %}
    <div class="breadcrumb">
        <a href="{{ path('device_index') }}">All Devices</a> &raquo;
        {% if device.vendor_slug %}
            <a href="{{ path('vendor_show', {slug: device.vendor_slug}) }}">{{ device.vendor_name ?? 'Unknown Vendor' }}</a>
        {% else %}
            {{ device.vendor_name ?? 'Unknown Vendor' }}
        {% endif %}
    </div>

    <div class="device-header">
        <div class="device-header-title">
            <h2>{{ device.product_name ?? 'Unknown Product' }}</h2>
            {% if deviceScore and deviceScore.scoresByType|length > 0 %}
                <div class="device-rating">
                    {{ stars(deviceScore.starRating, deviceScore.overallScore, true, deviceScore.isCompliant) }}
                    {% if not deviceScore.isCompliant %}
                        <span class="compliance-notice" title="This device is missing some mandatory clusters for full Matter spec compliance">Missing required clusters</span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        <div class="vendor">
            {% if device.vendor_slug %}
                <a href="{{ path('vendor_show', {slug: device.vendor_slug}) }}">{{ device.vendor_name ?? 'Unknown Vendor' }}</a>
            {% else %}
                {{ device.vendor_name ?? 'Unknown Vendor' }}
            {% endif %}
        </div>
        <div class="device-ids">
            <div class="device-id">
                <span class="label">Vendor ID:</span>
                <span class="value">{{ device.vendor_id ?? 'N/A' }}</span>
            </div>
            <div class="device-id">
                <span class="label">Product ID:</span>
                <span class="value">{{ device.product_id ?? 'N/A' }}</span>
            </div>
            <div class="device-id">
                <span class="label">Seen:</span>
                <span class="value">{{ device.submission_count|number_format }} time{{ device.submission_count != 1 ? 's' : '' }}</span>
            </div>
            {% if device.supports_binding %}
                <span class="badge badge-binding" title="This device can directly control other Matter devices via binding (device-to-device automation without a hub)">Supports Binding ‚ÑπÔ∏è</span>
            {% else %}
                <span class="badge badge-no-binding" title="This device cannot directly control other devices. It can only be controlled by a hub or controller." style="background: var(--gray-100); color: var(--gray-500);">No Binding</span>
            {% endif %}
            {% if device.connectivity_types %}
                {% set connTypes = device.connectivity_types|json_decode %}
                {% if connTypes %}
                    {% for connType in connTypes %}
                        <span class="badge badge-{{ connType }}" title="{{ connType|capitalize }} Network">{{ connType|capitalize }}</span>
                    {% endfor %}
                {% endif %}
            {% endif %}
            {% if product and product.discoveryCapabilitiesBitmask %}
                {% if product.discoveryCapabilitiesBitmask b-and 1 %}<span class="badge badge-softap" title="Can be discovered via SoftAP (Wi-Fi access point mode)">SoftAP</span>{% endif %}
                {% if product.discoveryCapabilitiesBitmask b-and 2 %}<span class="badge badge-ble" title="Can be discovered via Bluetooth Low Energy">BLE</span>{% endif %}
                {% if product.discoveryCapabilitiesBitmask b-and 4 %}<span class="badge badge-network" title="Can be discovered on the network (mDNS/DNS-SD)">On Network</span>{% endif %}
            {% endif %}
        </div>

        {# Certification info from DCL compliance-info #}
        {% if product and (product.certificationDate or product.certificateId) %}
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <span style="font-size: 0.75rem; text-transform: uppercase; color: var(--gray-500); display: block; margin-bottom: 0.5rem;">CSA Certification:</span>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                    {% if product.certificationDate %}
                        <span class="badge" style="background: #dcfce7; color: #166534;" title="Official CSA certification date">
                            Certified {{ product.certificationDate|date('M j, Y') }}
                        </span>
                    {% endif %}
                    {% if product.certificateId %}
                        <a href="https://csa-iot.org/csa-iot_products/{{ product.certificateId }}"
                           target="_blank"
                           rel="noopener"
                           class="badge"
                           style="background: #dbeafe; color: #1e40af; text-decoration: none;"
                           title="View certificate on CSA website">
                            {{ product.certificateId }}
                        </a>
                    {% endif %}
                    {% if product.softwareVersionString %}
                        <span style="font-size: 0.8125rem; color: var(--gray-500);">
                            v{{ product.softwareVersionString }}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# Product links from DCL #}
        {% if product and (product.productUrl or product.supportUrl or product.userManualUrl) %}
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <span style="font-size: 0.75rem; text-transform: uppercase; color: var(--gray-500); margin-right: 1rem;">Links:</span>
                {% if product.productUrl %}
                    <a href="{{ product.productUrl }}" target="_blank" rel="noopener" class="product-link">üîó Product Page</a>
                {% endif %}
                {% if product.supportUrl %}
                    <a href="{{ product.supportUrl }}" target="_blank" rel="noopener" class="product-link">üõü Support</a>
                {% endif %}
                {% if product.userManualUrl %}
                    <a href="{{ product.userManualUrl }}" target="_blank" rel="noopener" class="product-link">üìñ Manual</a>
                {% endif %}
            </div>
        {% endif %}
    </div>

    {# Human-friendly capabilities section #}
    {% include 'components/_capabilities.html.twig' with {
        capabilities: capabilities,
        deviceScore: deviceScore
    } %}

    {# Macro for decoding hint bitmask values #}
    {% macro hintBadges(hint) %}
        {% if hint is not null and hint > 0 %}
            {% if hint b-and 1 %}<span class="hint-badge hint-power">Power Cycle</span>{% endif %}
            {% if hint b-and 2 %}<span class="hint-badge hint-manual">Manual Control</span>{% endif %}
            {% if hint b-and 4 %}<span class="hint-badge hint-reset">Manual Reset</span>{% endif %}
            {% if hint b-and 8 %}<span class="hint-badge hint-custom">Custom App</span>{% endif %}
        {% else %}
            <span class="hint-badge hint-standard">Standard</span>
        {% endif %}
    {% endmacro %}

    {# Commissioning & Setup Info from DCL #}
    {% set hasSetupInfo = product and (
        product.commissioningInitialStepsInstruction or
        product.commissioningSecondaryStepsInstruction or
        product.factoryResetStepsInstruction or
        product.icdUserActiveModeTriggerInstruction or
        product.commissioningCustomFlowUrl or
        product.commissioningFallbackUrl or
        product.maintenanceUrl or
        product.commissioningInitialStepsHint or
        product.factoryResetStepsHint
    ) %}
    {% if hasSetupInfo %}
        <div class="collapsible-section" id="setup-section">
            <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                <h3>Setup & Reset Info</h3>
                <span class="collapsible-toggle">&#9660;</span>
            </div>
            <div class="collapsible-content" style="background: var(--blue-50);">
                <div>
            {% if product.commissioningInitialStepsHint is not null or product.factoryResetStepsHint is not null %}
                <div class="setup-complexity">
                    {% if product.commissioningInitialStepsHint is not null %}
                        <span class="setup-complexity-label">Setup:</span>
                        {{ _self.hintBadges(product.commissioningInitialStepsHint) }}
                    {% endif %}
                    {% if product.factoryResetStepsHint is not null %}
                        <span class="setup-complexity-label" style="margin-left: 1rem;">Reset:</span>
                        {{ _self.hintBadges(product.factoryResetStepsHint) }}
                    {% endif %}
                </div>
            {% endif %}
            {% if product.commissioningInitialStepsInstruction %}
                <div style="margin-bottom: 1rem;">
                    <strong style="font-size: 0.875rem;">Initial Setup:</strong>
                    <p style="font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0 0;">{{ product.commissioningInitialStepsInstruction }}</p>
                </div>
            {% endif %}
            {% if product.commissioningSecondaryStepsInstruction %}
                <div style="margin-bottom: 1rem;">
                    <strong style="font-size: 0.875rem;">Additional Steps:</strong>
                    <p style="font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0 0;">{{ product.commissioningSecondaryStepsInstruction }}</p>
                </div>
            {% endif %}
            {% if product.icdUserActiveModeTriggerInstruction %}
                <div style="margin-bottom: 1rem;">
                    <strong style="font-size: 0.875rem;">Wake Device (ICD):</strong>
                    <p style="font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0 0;">{{ product.icdUserActiveModeTriggerInstruction }}</p>
                </div>
            {% endif %}
            {% if product.factoryResetStepsInstruction %}
                <div style="margin-bottom: 1rem;">
                    <strong style="font-size: 0.875rem;">Factory Reset:</strong>
                    <p style="font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0 0;">{{ product.factoryResetStepsInstruction }}</p>
                </div>
            {% endif %}
            {% if product.commissioningCustomFlowUrl or product.commissioningFallbackUrl or product.maintenanceUrl %}
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    {% if product.commissioningCustomFlowUrl %}
                        <a href="{{ product.commissioningCustomFlowUrl }}" target="_blank" rel="noopener" class="product-link" style="font-size: 0.875rem;">Setup Guide</a>
                    {% endif %}
                    {% if product.commissioningFallbackUrl %}
                        <a href="{{ product.commissioningFallbackUrl }}" target="_blank" rel="noopener" class="product-link" style="font-size: 0.875rem;">Troubleshooting</a>
                    {% endif %}
                    {% if product.maintenanceUrl %}
                        <a href="{{ product.maintenanceUrl }}" target="_blank" rel="noopener" class="product-link" style="font-size: 0.875rem;">Maintenance</a>
                    {% endif %}
                </div>
            {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    {# Technical Details - Collapsible Section #}
    {% set hasTechnicalDetails = (compatibleDevices is not empty or canProvideToDevices is not empty) or (clusterGapAnalysis is not empty) or (endpoints is not empty) or (versions is not empty) %}
    {% if hasTechnicalDetails %}
    <div class="collapsible-section" id="technical-section">
        <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
            <h3>Technical Details <span class="section-badge">For developers</span></h3>
            <span class="collapsible-toggle">&#9660;</span>
        </div>
        <div class="collapsible-content">

    {% if compatibleDevices is not empty or canProvideToDevices is not empty %}
        <div class="compatibility-section">
            <h3>Device Compatibility</h3>

            {% if compatibleDevices is not empty %}
                <p style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem;">
                    <strong>Can control or read from:</strong> This device has client clusters that can interact with these devices' server clusters (e.g., a switch controlling a light)
                </p>
                {% for clusterId, data in compatibleDevices %}
                    <div class="compatibility-group">
                        <h4>
                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(clusterId)}) }}" class="cluster-name" style="text-decoration: none;">{{ data.name }}</a>
                            <span style="color: var(--gray-400);">({{ data.total }} device{{ data.total != 1 ? 's' : '' }})</span>
                        </h4>
                        <div class="compatible-devices">
                            {% for compatDevice in data.devices %}
                                <a href="{{ path('device_show', {slug: compatDevice.slug}) }}" class="compatible-device">
                                    {{ compatDevice.product_name ?? 'Unknown' }}
                                    <span style="opacity: 0.6; font-size: 0.75rem;">({{ compatDevice.vendor_name ?? 'Unknown' }})</span>
                                </a>
                            {% endfor %}
                            {% if data.total > data.devices|length %}
                                <span class="more-devices">+{{ data.total - data.devices|length }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            {% if canProvideToDevices is not empty %}
                {% if compatibleDevices is not empty %}
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                {% endif %}
                <p style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem;">
                    <strong>Can provide data to:</strong> These devices have client clusters that can read from or control this device's server clusters
                </p>
                {% for clusterId, data in canProvideToDevices %}
                    <div class="compatibility-group">
                        <h4>
                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(clusterId)}) }}" class="cluster-name" style="text-decoration: none;">{{ data.name }}</a>
                            <span style="color: var(--gray-400);">({{ data.total }} device{{ data.total != 1 ? 's' : '' }})</span>
                        </h4>
                        <div class="compatible-devices">
                            {% for compatDevice in data.devices %}
                                <a href="{{ path('device_show', {slug: compatDevice.slug}) }}" class="compatible-device">
                                    {{ compatDevice.product_name ?? 'Unknown' }}
                                    <span style="opacity: 0.6; font-size: 0.75rem;">({{ compatDevice.vendor_name ?? 'Unknown' }})</span>
                                </a>
                            {% endfor %}
                            {% if data.total > data.devices|length %}
                                <span class="more-devices">+{{ data.total - data.devices|length }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}

    {% if clusterGapAnalysis is not empty %}
        <div class="gap-analysis-section">
            <h3>Spec Compliance & Feature Analysis</h3>
            <p class="gap-analysis-subtitle">
                Comparing this device's clusters against Matter specification requirements. Shows what's implemented, what's missing, and bonus features.
                <em>Note: Legacy clusters (e.g., Scenes) count as compliant when replaced by newer equivalents (Scenes Management).</em>
            </p>

            {% for deviceTypeId, analysis in clusterGapAnalysis %}
                {% if analysis.deviceType %}
                    <div class="device-type-analysis">
                        <div class="device-type-analysis-header">
                            <span>
                                <a href="{{ path('stats_device_type_show', {type: deviceTypeId}) }}" class="device-type-analysis-name">
                                    {{ analysis.deviceType.name }}
                                </a>
                                {% if analysis.specVersion is defined %}
                                    <span class="spec-badge" style="background: var(--gray-200); color: var(--gray-600); margin-left: 0.5rem;" title="Matter specification version for this device type">
                                        Matter {{ analysis.specVersion }}
                                    </span>
                                {% endif %}
                            </span>
                            {% if analysis.compliance.mandatory %}
                                <span class="compliance-badge compliance-badge-success">Compliant</span>
                            {% else %}
                                <span class="compliance-badge compliance-badge-error">Missing Required</span>
                            {% endif %}
                        </div>

                        <div class="compliance-score">
                            {% set typeScore = deviceScore.scoresByType[deviceTypeId] ?? null %}
                            {% if typeScore %}
                                <span class="type-star-rating">
                                    {{ stars(typeScore.starRating, typeScore.score, false, typeScore.isCompliant) }}
                                </span>
                            {% endif %}
                            <span style="font-size: 0.75rem; color: var(--gray-500);">Feature Score:</span>
                            <div class="compliance-score-bar">
                                {% set displayScore = typeScore ? typeScore.score : analysis.compliance.score %}
                                <div class="compliance-score-fill {% if displayScore >= 80 %}compliance-score-fill-high{% elseif displayScore >= 50 %}compliance-score-fill-medium{% else %}compliance-score-fill-low{% endif %}"
                                     style="width: {{ displayScore }}%;"></div>
                            </div>
                            <span class="compliance-score-value">{{ typeScore ? typeScore.score : analysis.compliance.score }}%</span>
                            {% if typeScore and typeScore.clientBonus > 0 %}
                                <span class="client-bonus-indicator" title="Bonus for implementing key client clusters">+{{ typeScore.clientBonus|round(0) }}% bonus</span>
                            {% endif %}
                        </div>

                        <div class="gap-clusters-grid">
                            {# Missing Mandatory - Critical #}
                            {% if analysis.missingMandatoryServer is not empty or analysis.missingMandatoryClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Missing Required
                                        <span class="count" style="background: var(--red-200); color: var(--red-700);">
                                            {{ analysis.missingMandatoryServer|length + analysis.missingMandatoryClient|length }}
                                        </span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.missingMandatoryServer %}
                                            {% set specNote = matterRegistry.getClusterSpecNote(cluster.id) %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-mandatory"
                                               title="Missing mandatory server cluster{{ specNote ? '. ' ~ specNote : '' }}">
                                                {{ cluster.name }}
                                                {% if specNote %}<span style="font-size: 0.6rem; opacity: 0.8;">*</span>{% endif %}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.missingMandatoryClient %}
                                            {% set specNote = matterRegistry.getClusterSpecNote(cluster.id) %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-mandatory"
                                               title="Missing mandatory client cluster{{ specNote ? '. ' ~ specNote : '' }}">
                                                {{ cluster.name }} (client)
                                                {% if specNote %}<span style="font-size: 0.6rem; opacity: 0.8;">*</span>{% endif %}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Missing Optional - Could Have #}
                            {% if analysis.missingOptionalServer is not empty or analysis.missingOptionalClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title" title="These clusters are optional per the Matter spec. The manufacturer chose not to implement them, which is allowed.">
                                        Optional Not Implemented
                                        <span class="count">{{ analysis.missingOptionalServer|length + analysis.missingOptionalClient|length }}</span>
                                    </div>
                                    <p style="font-size: 0.6875rem; color: var(--gray-500); margin: 0 0 0.5rem; line-height: 1.3;">
                                        Per the Matter spec, these clusters are optional. The device is compliant without them.
                                    </p>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.missingOptionalServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-optional"
                                               title="Optional server cluster ‚Äì not required for compliance">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.missingOptionalClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-optional"
                                               title="Optional client cluster ‚Äì not required for compliance">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Implemented Optional - Bonus Features #}
                            {% if analysis.implementedOptionalServer is not empty or analysis.implementedOptionalClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Bonus Features Implemented
                                        <span class="count" style="background: var(--green-200); color: var(--green-700);">
                                            {{ analysis.implementedOptionalServer|length + analysis.implementedOptionalClient|length }}
                                        </span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.implementedOptionalServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-implemented"
                                               title="Optional server cluster implemented">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.implementedOptionalClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-implemented"
                                               title="Optional client cluster implemented">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Extra Clusters - Beyond Spec #}
                            {% if analysis.extraServer is not empty or analysis.extraClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Extra (Beyond Spec)
                                        <span class="count" style="background: var(--blue-200); color: var(--blue-700);">
                                            {{ analysis.extraServer|length + analysis.extraClient|length }}
                                        </span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.extraServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-extra"
                                               title="Server cluster not in device type spec">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.extraClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-extra"
                                               title="Client cluster not in device type spec">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-500);">
                            {{ analysis.compliance.implementedMandatory }}/{{ analysis.compliance.totalMandatory }} required |
                            {{ analysis.compliance.implementedOptional }}/{{ analysis.compliance.totalOptional }} optional
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {% if frequentlyPairedWith is not empty %}
        <div class="pairing-section">
            <h3>
                Frequently Paired With
                {% if installationCount > 0 %}
                    <span class="installation-stat">
                        Found in {{ installationCount }} installation{{ installationCount != 1 ? 's' : '' }}
                    </span>
                {% endif %}
            </h3>
            <p class="pairing-subtitle">
                These devices are commonly found together in the same smart home setup based on anonymous telemetry data.
            </p>
            <div class="paired-products">
                {% for paired in frequentlyPairedWith %}
                    <a href="{{ path('device_show', {slug: paired.slug}) }}" class="paired-product">
                        <span class="paired-product-name">{{ paired.product_name ?? 'Unknown Product' }}</span>
                        <span class="paired-product-vendor">{{ paired.vendor_name ?? 'Unknown Vendor' }}</span>
                        <div class="pairing-stats">
                            <span class="pairing-stat">
                                <span class="pairing-stat-value">{{ paired.shared_installations }}</span>
                                <span class="pairing-stat-label">shared</span>
                            </span>
                            <span class="pairing-stat">
                                <span class="pairing-stat-value">{{ paired.pairing_strength }}%</span>
                                <span class="pairing-stat-label">of installs</span>
                            </span>
                        </div>
                        <div class="pairing-strength-bar">
                            <div class="pairing-strength-fill" style="width: {{ paired.pairing_strength }}%;"></div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {% if endpoints is not empty %}
        <div class="section">
            <h3>Endpoints by Version</h3>
            {# Group endpoints by hardware version, then by software version #}
            {% set hwGroups = {} %}
            {% for ep in endpoints %}
                {% set hwKey = ep.hardware_version ?? 'unknown' %}
                {% set swKey = ep.software_version ?? 'unknown' %}
                {# Get current hw group or empty object #}
                {% set currentHwGroup = hwGroups[hwKey] ?? {} %}
                {# Get current sw group or empty array #}
                {% set currentSwGroup = currentHwGroup[swKey] ?? [] %}
                {# Add endpoint to sw group #}
                {% set currentSwGroup = currentSwGroup|merge([ep]) %}
                {# Update hw group with new sw group #}
                {% set currentHwGroup = currentHwGroup|merge({(swKey): currentSwGroup}) %}
                {# Update hwGroups with new hw group #}
                {% set hwGroups = hwGroups|merge({(hwKey): currentHwGroup}) %}
            {% endfor %}

            {% for hwVersion, swGroups in hwGroups %}
                <div class="hardware-group" style="margin-bottom: 2rem;">
                    <h4 style="font-size: 1rem; color: var(--gray-600); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--gray-200);">
                        Hardware: {{ hwVersion != 'unknown' ? hwVersion : 'N/A' }}
                    </h4>

                    {% set swVersionKeys = swGroups|keys %}

                    {% for swVersion, versionEndpoints in swGroups %}
                        {% set swVersionIndex = loop.index0 %}
                        {# Look at next software version (older, since sorted DESC) within same hardware #}
                        {% set olderSwVersion = not loop.last ? swVersionKeys[swVersionIndex + 1] : null %}

                <div class="version-group">
                    <div class="version-header">
                        <span class="version-label">
                            SW: {{ swVersion != 'unknown' ? swVersion : 'N/A' }}
                            {% if loop.first %}<span class="badge" style="margin-left: 0.5rem; font-size: 0.625rem;" title="Most recent version observed in our telemetry data">Latest Seen</span>{% endif %}
                        </span>
                        <span class="endpoint-count">{{ versionEndpoints|length }} endpoint{{ versionEndpoints|length != 1 ? 's' : '' }}</span>
                    </div>

                    {% for ep in versionEndpoints %}
                        {# Find matching endpoint in older software version (within same hardware) for diff #}
                        {% set olderEndpoint = null %}
                        {% if olderSwVersion and swGroups[olderSwVersion] is defined %}
                            {% for olderEp in swGroups[olderSwVersion] %}
                                {% if olderEp.endpoint_id == ep.endpoint_id %}
                                    {% set olderEndpoint = olderEp %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {# Calculate cluster diff (what changed from older version to this version) #}
                        {% set addedServerClusters = [] %}
                        {% set removedServerClusters = [] %}
                        {% set addedClientClusters = [] %}
                        {% set removedClientClusters = [] %}

                        {% if olderEndpoint %}
                            {# Find added server clusters (in current but not in older) #}
                            {% for cluster in ep.server_clusters %}
                                {% if cluster not in olderEndpoint.server_clusters %}
                                    {% set addedServerClusters = addedServerClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                            {# Find removed server clusters (in older but not in current) #}
                            {% for cluster in olderEndpoint.server_clusters %}
                                {% if cluster not in ep.server_clusters %}
                                    {% set removedServerClusters = removedServerClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                            {# Find added client clusters #}
                            {% for cluster in ep.client_clusters %}
                                {% if cluster not in olderEndpoint.client_clusters %}
                                    {% set addedClientClusters = addedClientClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                            {# Find removed client clusters #}
                            {% for cluster in olderEndpoint.client_clusters %}
                                {% if cluster not in ep.client_clusters %}
                                    {% set removedClientClusters = removedClientClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <div class="endpoint">
                            <div class="endpoint-header">
                                <h4>Endpoint {{ ep.endpoint_id }}</h4>
                                {% if ep.has_binding_cluster %}
                                    <span class="badge badge-binding">Has Binding Cluster</span>
                                {% endif %}
                            </div>

                    {% if ep.device_types is not empty %}
                        <div class="device-types">
                            <div class="label">Device Types</div>
                            <div class="tag-list">
                                {% for dt in ep.device_types %}
                                    {# Handle both object format {"id": 256} and plain integer format 256 #}
                                    {% set dtId = dt.id is defined ? dt.id : dt %}
                                    {% set meta = matterRegistry.getDeviceTypeMetadata(dtId) %}
                                    {% set categoryClass = meta ? 'tag-category-' ~ meta.displayCategory|lower : 'tag-primary' %}
                                    <a href="{{ path('stats_device_type_show', {type: dtId}) }}" class="tag {{ categoryClass }}" title="{{ meta.description ?? 'Unknown device type' }}">
                                        <span class="device-icon">{{ _self.deviceIcon(meta.icon ?? 'device') }}</span>
                                        {{ meta.name ?? ('Device Type ' ~ dtId) }}
                                        {% if meta.specVersion is defined and meta.specVersion != '1.0' %}
                                            <span class="spec-badge">{{ meta.specVersion }}</span>
                                        {% endif %}
                                        <span class="tag-id">#{{ dtId }}</span>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if ep.server_clusters is not empty %}
                        <div class="clusters">
                            <div class="label">Server Clusters <span style="font-size: 0.625rem; opacity: 0.7;">(hover for details)</span>{% if ep.schema_version is defined and ep.schema_version >= 3 %}<span style="font-size: 0.625rem; color: #86efac; margin-left: 0.5rem;">‚úì Rich data</span>{% endif %}</div>
                            <div class="tag-list">
                                {% for cluster in ep.server_clusters %}
                                    {{ _self.clusterTag(cluster, matterRegistry, false, ep.server_cluster_details) }}
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if ep.client_clusters is not empty %}
                        <div class="clusters">
                            <div class="label">Client Clusters <span style="font-size: 0.625rem; opacity: 0.7;">(hover for details)</span></div>
                            <div class="tag-list">
                                {% for cluster in ep.client_clusters %}
                                    {{ _self.clusterTag(cluster, matterRegistry, true, ep.client_cluster_details) }}
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {# Show diff from previous version #}
                    {% if addedServerClusters|length > 0 or removedServerClusters|length > 0 or addedClientClusters|length > 0 or removedClientClusters|length > 0 %}
                        <div class="version-diff">
                            <div class="diff-title">Changes from previous version:</div>
                            {% if addedServerClusters|length > 0 %}
                                <div>
                                    {% for cluster in addedServerClusters %}
                                        <span class="diff-item diff-added">{{ matterRegistry.getClusterName(cluster) }} (server)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if removedServerClusters|length > 0 %}
                                <div>
                                    {% for cluster in removedServerClusters %}
                                        <span class="diff-item diff-removed">{{ matterRegistry.getClusterName(cluster) }} (server)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if addedClientClusters|length > 0 %}
                                <div>
                                    {% for cluster in addedClientClusters %}
                                        <span class="diff-item diff-added">{{ matterRegistry.getClusterName(cluster) }} (client)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if removedClientClusters|length > 0 %}
                                <div>
                                    {% for cluster in removedClientClusters %}
                                        <span class="diff-item diff-removed">{{ matterRegistry.getClusterName(cluster) }} (client)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                        </div>
                    {% endfor %}
                </div>
                    {% endfor %}{# end swVersion loop #}
                </div>{# end hardware-group #}
            {% endfor %}{# end hwVersion loop #}
        </div>
    {% endif %}

    {% if versions is not empty %}
        <div class="section">
            <h3>Known Versions</h3>
            <table class="versions-table">
                <thead>
                    <tr>
                        <th>Hardware Version</th>
                        <th>Software Version</th>
                        <th>Count</th>
                        <th>First Seen</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in versions %}
                        <tr>
                            <td>{{ v.hardware_version ?? 'N/A' }}</td>
                            <td>{{ v.software_version ?? 'N/A' }}</td>
                            <td>{{ v.count|number_format }}</td>
                            <td>{{ v.first_seen }}</td>
                            <td>{{ v.last_seen }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

        </div>{# End collapsible-content #}
    </div>{# End collapsible-section #}
    {% endif %}{# End hasTechnicalDetails #}

    <div class="back-link">
        <a href="{{ path('device_index') }}">&laquo; Back to device index</a>
    </div>
{% endblock %}
