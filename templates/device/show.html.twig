{% extends 'base.html.twig' %}

{# Macro for device type icons using Unicode symbols #}
{% macro deviceIcon(icon) %}
    {%- set icons = {
        'lightbulb': 'ğŸ’¡',
        'lock': 'ğŸ”’',
        'thermometer': 'ğŸŒ¡ï¸',
        'fan': 'ğŸŒ€',
        'plug': 'ğŸ”Œ',
        'tv': 'ğŸ“º',
        'speaker': 'ğŸ”Š',
        'volume-up': 'ğŸ”Š',
        'door-open': 'ğŸšª',
        'droplet': 'ğŸ’§',
        'water': 'ğŸ’§',
        'snowflake': 'â„ï¸',
        'fire': 'ğŸ”¥',
        'sun': 'â˜€ï¸',
        'wind': 'ğŸ’¨',
        'leaf': 'ğŸŒ¿',
        'bolt': 'âš¡',
        'battery': 'ğŸ”‹',
        'battery-full': 'ğŸ”‹',
        'solar-panel': 'â˜€ï¸',
        'charging-station': 'ğŸ”Œ',
        'server': 'ğŸ–¥ï¸',
        'hub': 'ğŸ›ï¸',
        'bridge': 'ğŸŒ‰',
        'router': 'ğŸ“¡',
        'network-wired': 'ğŸŒ',
        'toggle-on': 'ğŸ”˜',
        'sliders': 'ğŸšï¸',
        'palette': 'ğŸ¨',
        'blinds': 'ğŸªŸ',
        'gauge': 'ğŸ“Š',
        'bell': 'ğŸ””',
        'motion-sensor': 'ğŸ‘ï¸',
        'robot': 'ğŸ¤–',
        'washing-machine': 'ğŸ§º',
        'microwave': 'ğŸ“¦',
        'utensils': 'ğŸ½ï¸',
        'box': 'ğŸ“¦',
        'faucet': 'ğŸš°',
        'cloud-rain': 'ğŸŒ§ï¸',
        'play-circle': 'â–¶ï¸',
        'cast': 'ğŸ“²',
        'remote': 'ğŸ®',
        'download': 'â¬‡ï¸',
        'upload': 'â¬†ï¸',
        'device': 'ğŸ“±'
    } -%}
    {{- icons[icon] ?? 'ğŸ“±' -}}
{% endmacro %}

{% block title %}{{ device.product_name ?? 'Unknown Device' }} - Matter Survey{% endblock %}

{% block header_subtitle %}{% endblock %}

{% block extra_styles %}
    .breadcrumb {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
    }

    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }

    .device-header {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .device-header h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .device-header .vendor {
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .device-ids {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .device-id {
        font-size: 0.875rem;
    }

    .device-id .label {
        color: var(--gray-500);
    }

    .device-id .value {
        font-family: monospace;
        background: var(--gray-100);
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
    }

    .section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .section h3 {
        font-size: 1.125rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .endpoint {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .endpoint:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .endpoint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .endpoint-header h4 {
        font-size: 1rem;
        font-weight: 600;
    }

    .device-types, .clusters {
        margin-bottom: 0.75rem;
    }

    .device-types .label, .clusters .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.25rem;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: var(--gray-100);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        cursor: default;
        position: relative;
    }

    .tag[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--gray-800);
        color: white;
        padding: 0.375rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 0.25rem;
        max-width: 250px;
        white-space: normal;
        text-align: center;
    }

    .tag-primary {
        background: var(--blue-100);
        color: var(--blue-700);
    }

    /* Category-based colors */
    .tag-category-lights {
        background: #fef3c7;
        color: #92400e;
    }

    .tag-category-climate {
        background: #dbeafe;
        color: #1e40af;
    }

    .tag-category-sensors {
        background: #d1fae5;
        color: #065f46;
    }

    .tag-category-security {
        background: #fee2e2;
        color: #991b1b;
    }

    .tag-category-appliances {
        background: #f3e8ff;
        color: #6b21a8;
    }

    .tag-category-entertainment {
        background: #fce7f3;
        color: #9d174d;
    }

    .tag-category-energy {
        background: #ecfccb;
        color: #3f6212;
    }

    .tag-category-system {
        background: var(--gray-200);
        color: var(--gray-700);
    }

    .tag .device-icon {
        font-size: 0.875rem;
        opacity: 0.8;
    }

    .spec-badge {
        display: inline-block;
        padding: 0.0625rem 0.25rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0.1875rem;
        font-size: 0.625rem;
        font-weight: 600;
        margin-left: 0.125rem;
    }

    .tag-id {
        opacity: 0.6;
        font-size: 0.75rem;
    }

    .versions-table {
        width: 100%;
        border-collapse: collapse;
    }

    .versions-table th, .versions-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-200);
    }

    .versions-table th {
        font-weight: 600;
        color: var(--gray-500);
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .back-link {
        margin-bottom: 1rem;
    }

    .back-link a {
        color: var(--primary);
        text-decoration: none;
    }
{% endblock %}

{% block body %}
    <div class="breadcrumb">
        <a href="{{ path('device_index') }}">All Devices</a> &raquo;
        {% if device.vendor_slug %}
            <a href="{{ path('vendor_show', {slug: device.vendor_slug}) }}">{{ device.vendor_name ?? 'Unknown Vendor' }}</a>
        {% else %}
            {{ device.vendor_name ?? 'Unknown Vendor' }}
        {% endif %}
    </div>

    <div class="device-header">
        <h2>{{ device.product_name ?? 'Unknown Product' }}</h2>
        <div class="vendor">
            {% if device.vendor_slug %}
                <a href="{{ path('vendor_show', {slug: device.vendor_slug}) }}">{{ device.vendor_name ?? 'Unknown Vendor' }}</a>
            {% else %}
                {{ device.vendor_name ?? 'Unknown Vendor' }}
            {% endif %}
        </div>
        <div class="device-ids">
            <div class="device-id">
                <span class="label">Vendor ID:</span>
                <span class="value">{{ device.vendor_id ?? 'N/A' }}</span>
            </div>
            <div class="device-id">
                <span class="label">Product ID:</span>
                <span class="value">{{ device.product_id ?? 'N/A' }}</span>
            </div>
            <div class="device-id">
                <span class="label">Seen:</span>
                <span class="value">{{ device.submission_count|number_format }} time{{ device.submission_count != 1 ? 's' : '' }}</span>
            </div>
            {% if device.supports_binding %}
                <span class="badge badge-binding">Supports Binding</span>
            {% endif %}
        </div>
    </div>

    {% if endpoints is not empty %}
        <div class="section">
            <h3>Endpoints ({{ endpoints|length }})</h3>
            {% for ep in endpoints %}
                <div class="endpoint">
                    <div class="endpoint-header">
                        <h4>Endpoint {{ ep.endpoint_id }}</h4>
                        {% if ep.has_binding_cluster %}
                            <span class="badge badge-binding">Has Binding Cluster</span>
                        {% endif %}
                    </div>

                    {% if ep.device_types is not empty %}
                        <div class="device-types">
                            <div class="label">Device Types</div>
                            <div class="tag-list">
                                {% for dt in ep.device_types %}
                                    {% set meta = matterRegistry.getDeviceTypeMetadata(dt.id) %}
                                    {% set categoryClass = meta ? 'tag-category-' ~ meta.displayCategory|lower : 'tag-primary' %}
                                    <span class="tag {{ categoryClass }}" title="{{ meta.description ?? 'Unknown device type' }}">
                                        <span class="device-icon">{{ _self.deviceIcon(meta.icon ?? 'device') }}</span>
                                        {{ meta.name ?? ('Device Type ' ~ dt.id) }}
                                        {% if meta.specVersion is defined and meta.specVersion != '1.0' %}
                                            <span class="spec-badge">{{ meta.specVersion }}</span>
                                        {% endif %}
                                        <span class="tag-id">#{{ dt.id }}</span>
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if ep.clusters is not empty %}
                        <div class="clusters">
                            <div class="label">Clusters</div>
                            <div class="tag-list">
                                {% for cluster in ep.clusters %}
                                    <span class="tag">{{ matterRegistry.getClusterName(cluster) }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if versions is not empty %}
        <div class="section">
            <h3>Known Versions</h3>
            <table class="versions-table">
                <thead>
                    <tr>
                        <th>Hardware Version</th>
                        <th>Software Version</th>
                        <th>Count</th>
                        <th>First Seen</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in versions %}
                        <tr>
                            <td>{{ v.hardware_version ?? 'N/A' }}</td>
                            <td>{{ v.software_version ?? 'N/A' }}</td>
                            <td>{{ v.count|number_format }}</td>
                            <td>{{ v.first_seen }}</td>
                            <td>{{ v.last_seen }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <div class="back-link">
        <a href="{{ path('device_index') }}">&laquo; Back to device index</a>
    </div>
{% endblock %}
