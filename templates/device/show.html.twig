{% extends 'base.html.twig' %}

{# Macro for device type icons using Unicode symbols #}
{% macro deviceIcon(icon) %}
    {%- set icons = {
        'lightbulb': 'üí°',
        'lock': 'üîí',
        'thermometer': 'üå°Ô∏è',
        'fan': 'üåÄ',
        'plug': 'üîå',
        'tv': 'üì∫',
        'speaker': 'üîä',
        'volume-up': 'üîä',
        'door-open': 'üö™',
        'droplet': 'üíß',
        'water': 'üíß',
        'snowflake': '‚ùÑÔ∏è',
        'fire': 'üî•',
        'sun': '‚òÄÔ∏è',
        'wind': 'üí®',
        'leaf': 'üåø',
        'bolt': '‚ö°',
        'battery': 'üîã',
        'battery-full': 'üîã',
        'solar-panel': '‚òÄÔ∏è',
        'charging-station': 'üîå',
        'server': 'üñ•Ô∏è',
        'hub': 'üéõÔ∏è',
        'bridge': 'üåâ',
        'router': 'üì°',
        'network-wired': 'üåê',
        'toggle-on': 'üîò',
        'sliders': 'üéöÔ∏è',
        'palette': 'üé®',
        'blinds': 'ü™ü',
        'gauge': 'üìä',
        'bell': 'üîî',
        'motion-sensor': 'üëÅÔ∏è',
        'robot': 'ü§ñ',
        'washing-machine': 'üß∫',
        'microwave': 'üì¶',
        'utensils': 'üçΩÔ∏è',
        'box': 'üì¶',
        'faucet': 'üö∞',
        'cloud-rain': 'üåßÔ∏è',
        'play-circle': '‚ñ∂Ô∏è',
        'cast': 'üì≤',
        'remote': 'üéÆ',
        'download': '‚¨áÔ∏è',
        'upload': '‚¨ÜÔ∏è',
        'device': 'üì±'
    } -%}
    {{- icons[icon] ?? 'üì±' -}}
{% endmacro %}

{% block title %}{{ device.product_name ?? 'Unknown Device' }} - Matter Survey{% endblock %}

{% block og_title %}{{ device.product_name ?? 'Unknown Device' }} by {{ device.vendor_name ?? 'Unknown Vendor' }}{% endblock %}
{% block og_description %}Matter smart home device: {{ device.product_name ?? 'Unknown Device' }} from {{ device.vendor_name ?? 'Unknown Vendor' }}. Vendor ID: {{ device.vendor_id }}, Product ID: {{ device.product_id }}. View device capabilities, endpoints, and compatible devices.{% endblock %}
{% block og_type %}product{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Product",
    "name": {{ (device.product_name ?? 'Unknown Device')|json_encode|raw }},
    "description": {{ ("Matter smart home device with " ~ (endpoints|length) ~ " endpoint(s)")|json_encode|raw }},
    "productID": "{{ device.vendor_id }}:{{ device.product_id }}",
    "sku": "{{ device.vendor_id }}-{{ device.product_id }}",
    "category": "Smart Home Device",
    "manufacturer": {
        "@type": "Organization",
        "name": {{ (device.vendor_name ?? 'Unknown Vendor')|json_encode|raw }}
        {%- if device.vendor_slug %},
        "url": "{{ url('vendor_show', {slug: device.vendor_slug}) }}"
        {%- endif %}

    },
    "additionalProperty": [
        {
            "@type": "PropertyValue",
            "name": "Vendor ID",
            "value": "{{ device.vendor_id }}"
        },
        {
            "@type": "PropertyValue",
            "name": "Product ID",
            "value": "{{ device.product_id }}"
        },
        {
            "@type": "PropertyValue",
            "name": "Supports Binding",
            "value": "{{ device.supports_binding ? 'Yes' : 'No' }}"
        }
    ]
}
</script>
{% endblock %}

{% block header_subtitle %}{% endblock %}

{% block extra_styles %}
    .breadcrumb {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
    }

    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }

    .device-header {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .device-header h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .device-header .vendor {
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .device-ids {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .device-id {
        font-size: 0.875rem;
    }

    .device-id .label {
        color: var(--gray-500);
    }

    .device-id .value {
        font-family: monospace;
        background: var(--gray-100);
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
    }

    .section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .section h3 {
        font-size: 1.125rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .endpoint {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .endpoint:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .version-group {
        margin-bottom: 1.5rem;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
    }

    .version-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
    }

    .version-label {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    .endpoint-count {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .version-group .endpoint {
        margin: 0;
        padding: 1rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .version-group .endpoint:last-child {
        border-bottom: none;
    }

    .version-diff {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--gray-50);
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }

    .version-diff .diff-title {
        font-weight: 600;
        color: var(--gray-600);
        margin-bottom: 0.25rem;
    }

    .diff-added {
        color: #166534;
    }

    .diff-removed {
        color: #991b1b;
    }

    .diff-added::before {
        content: "+ ";
        font-weight: 600;
    }

    .diff-removed::before {
        content: "‚àí ";
        font-weight: 600;
    }

    .diff-item {
        display: inline-block;
        margin-right: 0.5rem;
    }

    .endpoint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .endpoint-header h4 {
        font-size: 1rem;
        font-weight: 600;
    }

    .device-types, .clusters {
        margin-bottom: 0.75rem;
    }

    .device-types .label, .clusters .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.25rem;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: var(--gray-100);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        position: relative;
        text-decoration: none;
        color: inherit;
        transition: opacity 0.15s;
    }

    a.tag {
        cursor: pointer;
    }

    a.tag:hover {
        opacity: 0.8;
    }

    .tag[title] {
        position: relative;
    }

    .tag[title]:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 1rem;
        border: 6px solid transparent;
        border-top-color: #1f2937;
        z-index: 10000;
    }

    .tag[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: calc(100% + 10px);
        left: 0;
        background: #1f2937;
        color: #ffffff;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        z-index: 9999;
        width: max-content;
        max-width: 400px;
        white-space: normal;
        text-align: left;
        line-height: 1.5;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        pointer-events: none;
    }

    .tag-primary {
        background: var(--blue-100);
        color: var(--blue-700);
    }

    .tag-client {
        background: #dbeafe;
        color: #1e40af;
        border: 1px dashed #93c5fd;
    }

    /* Category-based colors */
    .tag-category-lights {
        background: #fef3c7;
        color: #92400e;
    }

    .tag-category-climate {
        background: #dbeafe;
        color: #1e40af;
    }

    .tag-category-sensors {
        background: #d1fae5;
        color: #065f46;
    }

    .tag-category-security {
        background: #fee2e2;
        color: #991b1b;
    }

    .tag-category-appliances {
        background: #f3e8ff;
        color: #6b21a8;
    }

    .tag-category-entertainment {
        background: #fce7f3;
        color: #9d174d;
    }

    .tag-category-energy {
        background: #ecfccb;
        color: #3f6212;
    }

    .tag-category-system {
        background: var(--gray-200);
        color: var(--gray-700);
    }

    .tag .device-icon {
        font-size: 0.875rem;
        opacity: 0.8;
    }

    .spec-badge {
        display: inline-block;
        padding: 0.0625rem 0.25rem;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0.1875rem;
        font-size: 0.625rem;
        font-weight: 600;
        margin-left: 0.125rem;
    }

    .tag-id {
        opacity: 0.6;
        font-size: 0.75rem;
    }

    .versions-table {
        width: 100%;
        border-collapse: collapse;
    }

    .versions-table th, .versions-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-200);
    }

    .versions-table th {
        font-weight: 600;
        color: var(--gray-500);
        font-size: 0.75rem;
        text-transform: uppercase;
    }

    .back-link {
        margin-bottom: 1rem;
    }

    .back-link a {
        color: var(--primary);
        text-decoration: none;
    }

    .compatibility-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .compatibility-section h3 {
        font-size: 1.125rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .compatibility-group {
        margin-bottom: 1.25rem;
    }

    .compatibility-group:last-child {
        margin-bottom: 0;
    }

    .compatibility-group h4 {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .compatibility-group h4 .cluster-name {
        color: var(--gray-900);
        font-weight: 600;
    }

    .compatible-devices {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .compatible-device {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: var(--gray-100);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        text-decoration: none;
        color: var(--gray-700);
        transition: background 0.15s, color 0.15s;
    }

    .compatible-device:hover {
        background: var(--primary);
        color: white;
    }

    .more-devices {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.8125rem;
        color: var(--gray-500);
    }

    .pairing-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .pairing-section h3 {
        font-size: 1.125rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .pairing-subtitle {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .paired-products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 0.75rem;
    }

    .paired-product {
        display: flex;
        flex-direction: column;
        padding: 0.75rem;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 0.375rem;
        text-decoration: none;
        color: inherit;
        transition: border-color 0.15s, box-shadow 0.15s;
    }

    .paired-product:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .paired-product-name {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
        color: var(--gray-900);
    }

    .paired-product-vendor {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
    }

    .pairing-stats {
        display: flex;
        gap: 0.75rem;
        font-size: 0.75rem;
    }

    .pairing-stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .pairing-stat-value {
        font-weight: 600;
        color: var(--primary);
    }

    .pairing-stat-label {
        color: var(--gray-500);
    }

    .pairing-strength-bar {
        width: 100%;
        height: 4px;
        background: var(--gray-200);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .pairing-strength-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 2px;
    }

    .installation-stat {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: var(--blue-50);
        border: 1px solid var(--blue-200);
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        color: var(--blue-700);
        margin-left: 0.5rem;
    }

    .gap-analysis-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--gray-200);
        margin-bottom: 1.5rem;
    }

    .gap-analysis-section h3 {
        font-size: 1.125rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .gap-analysis-subtitle {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }

    .device-type-analysis {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: 0.5rem;
    }

    .device-type-analysis:last-child {
        margin-bottom: 0;
    }

    .device-type-analysis-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .device-type-analysis-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--gray-900);
    }

    .compliance-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .compliance-badge-success {
        background: var(--green-100);
        color: var(--green-700);
    }

    .compliance-badge-warning {
        background: var(--yellow-100);
        color: var(--yellow-700);
    }

    .compliance-badge-error {
        background: var(--red-100);
        color: var(--red-700);
    }

    .compliance-score {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .compliance-score-bar {
        flex: 1;
        height: 8px;
        background: var(--gray-200);
        border-radius: 4px;
        overflow: hidden;
    }

    .compliance-score-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s;
    }

    .compliance-score-fill-high {
        background: var(--green-500);
    }

    .compliance-score-fill-medium {
        background: var(--yellow-500);
    }

    .compliance-score-fill-low {
        background: var(--red-500);
    }

    .compliance-score-value {
        font-weight: 600;
        font-size: 0.875rem;
        min-width: 3rem;
        text-align: right;
    }

    .gap-clusters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .gap-cluster-group {
        padding: 0.75rem;
        background: white;
        border-radius: 0.375rem;
        border: 1px solid var(--gray-200);
    }

    .gap-cluster-group-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .gap-cluster-group-title .count {
        background: var(--gray-200);
        padding: 0.125rem 0.375rem;
        border-radius: 9999px;
        font-size: 0.625rem;
    }

    .gap-cluster-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .gap-cluster-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        text-decoration: none;
    }

    .gap-cluster-missing-mandatory {
        background: var(--red-100);
        color: var(--red-700);
        border: 1px solid var(--red-200);
    }

    .gap-cluster-missing-optional {
        background: var(--gray-100);
        color: var(--gray-600);
        border: 1px dashed var(--gray-300);
    }

    .gap-cluster-implemented {
        background: var(--green-100);
        color: var(--green-700);
        border: 1px solid var(--green-200);
    }

    .gap-cluster-extra {
        background: var(--blue-100);
        color: var(--blue-700);
        border: 1px solid var(--blue-200);
    }

    .gap-empty {
        font-size: 0.8125rem;
        color: var(--gray-400);
        font-style: italic;
    }
{% endblock %}

{% block body %}
    <div class="breadcrumb">
        <a href="{{ path('device_index') }}">All Devices</a> &raquo;
        {% if device.vendor_slug %}
            <a href="{{ path('vendor_show', {slug: device.vendor_slug}) }}">{{ device.vendor_name ?? 'Unknown Vendor' }}</a>
        {% else %}
            {{ device.vendor_name ?? 'Unknown Vendor' }}
        {% endif %}
    </div>

    <div class="device-header">
        <h2>{{ device.product_name ?? 'Unknown Product' }}</h2>
        <div class="vendor">
            {% if device.vendor_slug %}
                <a href="{{ path('vendor_show', {slug: device.vendor_slug}) }}">{{ device.vendor_name ?? 'Unknown Vendor' }}</a>
            {% else %}
                {{ device.vendor_name ?? 'Unknown Vendor' }}
            {% endif %}
        </div>
        <div class="device-ids">
            <div class="device-id">
                <span class="label">Vendor ID:</span>
                <span class="value">{{ device.vendor_id ?? 'N/A' }}</span>
            </div>
            <div class="device-id">
                <span class="label">Product ID:</span>
                <span class="value">{{ device.product_id ?? 'N/A' }}</span>
            </div>
            <div class="device-id">
                <span class="label">Seen:</span>
                <span class="value">{{ device.submission_count|number_format }} time{{ device.submission_count != 1 ? 's' : '' }}</span>
            </div>
            {% if device.supports_binding %}
                <span class="badge badge-binding">Supports Binding</span>
            {% endif %}
            {% if device.connectivity_types %}
                {% set connTypes = device.connectivity_types|json_decode %}
                {% if connTypes %}
                    {% for connType in connTypes %}
                        <span class="badge badge-{{ connType }}" title="{{ connType|capitalize }} Network">{{ connType|capitalize }}</span>
                    {% endfor %}
                {% endif %}
            {% endif %}
        </div>
    </div>

    {% if compatibleDevices is not empty or canProvideToDevices is not empty %}
        <div class="compatibility-section">
            <h3>Device Compatibility</h3>

            {% if compatibleDevices is not empty %}
                <p style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem;">
                    <strong>Can control or read from:</strong> Based on client clusters
                </p>
                {% for clusterId, data in compatibleDevices %}
                    <div class="compatibility-group">
                        <h4>
                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(clusterId)}) }}" class="cluster-name" style="text-decoration: none;">{{ data.name }}</a>
                            <span style="color: var(--gray-400);">({{ data.total }} device{{ data.total != 1 ? 's' : '' }})</span>
                        </h4>
                        <div class="compatible-devices">
                            {% for compatDevice in data.devices %}
                                <a href="{{ path('device_show', {slug: compatDevice.slug}) }}" class="compatible-device">
                                    {{ compatDevice.product_name ?? 'Unknown' }}
                                    <span style="opacity: 0.6; font-size: 0.75rem;">({{ compatDevice.vendor_name ?? 'Unknown' }})</span>
                                </a>
                            {% endfor %}
                            {% if data.total > data.devices|length %}
                                <span class="more-devices">+{{ data.total - data.devices|length }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            {% if canProvideToDevices is not empty %}
                {% if compatibleDevices is not empty %}
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                {% endif %}
                <p style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem;">
                    <strong>Can provide data to:</strong> Based on server clusters
                </p>
                {% for clusterId, data in canProvideToDevices %}
                    <div class="compatibility-group">
                        <h4>
                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(clusterId)}) }}" class="cluster-name" style="text-decoration: none;">{{ data.name }}</a>
                            <span style="color: var(--gray-400);">({{ data.total }} device{{ data.total != 1 ? 's' : '' }})</span>
                        </h4>
                        <div class="compatible-devices">
                            {% for compatDevice in data.devices %}
                                <a href="{{ path('device_show', {slug: compatDevice.slug}) }}" class="compatible-device">
                                    {{ compatDevice.product_name ?? 'Unknown' }}
                                    <span style="opacity: 0.6; font-size: 0.75rem;">({{ compatDevice.vendor_name ?? 'Unknown' }})</span>
                                </a>
                            {% endfor %}
                            {% if data.total > data.devices|length %}
                                <span class="more-devices">+{{ data.total - data.devices|length }} more</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}

    {% if clusterGapAnalysis is not empty %}
        <div class="gap-analysis-section">
            <h3>Spec Compliance & Feature Analysis</h3>
            <p class="gap-analysis-subtitle">
                Comparing this device's clusters against Matter specification requirements. Shows what's implemented, what's missing, and bonus features.
            </p>

            {% for deviceTypeId, analysis in clusterGapAnalysis %}
                {% if analysis.deviceType %}
                    <div class="device-type-analysis">
                        <div class="device-type-analysis-header">
                            <a href="{{ path('stats_device_type_show', {type: deviceTypeId}) }}" class="device-type-analysis-name">
                                {{ analysis.deviceType.name }}
                            </a>
                            {% if analysis.compliance.mandatory %}
                                <span class="compliance-badge compliance-badge-success">Compliant</span>
                            {% else %}
                                <span class="compliance-badge compliance-badge-error">Missing Required</span>
                            {% endif %}
                        </div>

                        <div class="compliance-score">
                            <span style="font-size: 0.75rem; color: var(--gray-500);">Feature Score:</span>
                            <div class="compliance-score-bar">
                                <div class="compliance-score-fill {% if analysis.compliance.score >= 80 %}compliance-score-fill-high{% elseif analysis.compliance.score >= 50 %}compliance-score-fill-medium{% else %}compliance-score-fill-low{% endif %}"
                                     style="width: {{ analysis.compliance.score }}%;"></div>
                            </div>
                            <span class="compliance-score-value">{{ analysis.compliance.score }}%</span>
                        </div>

                        <div class="gap-clusters-grid">
                            {# Missing Mandatory - Critical #}
                            {% if analysis.missingMandatoryServer is not empty or analysis.missingMandatoryClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Missing Required
                                        <span class="count" style="background: var(--red-200); color: var(--red-700);">
                                            {{ analysis.missingMandatoryServer|length + analysis.missingMandatoryClient|length }}
                                        </span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.missingMandatoryServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-mandatory"
                                               title="Missing mandatory server cluster">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.missingMandatoryClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-mandatory"
                                               title="Missing mandatory client cluster">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Missing Optional - Could Have #}
                            {% if analysis.missingOptionalServer is not empty or analysis.missingOptionalClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Available But Not Implemented
                                        <span class="count">{{ analysis.missingOptionalServer|length + analysis.missingOptionalClient|length }}</span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.missingOptionalServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-optional"
                                               title="Optional server cluster not implemented">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.missingOptionalClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-missing-optional"
                                               title="Optional client cluster not implemented">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Implemented Optional - Bonus Features #}
                            {% if analysis.implementedOptionalServer is not empty or analysis.implementedOptionalClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Bonus Features Implemented
                                        <span class="count" style="background: var(--green-200); color: var(--green-700);">
                                            {{ analysis.implementedOptionalServer|length + analysis.implementedOptionalClient|length }}
                                        </span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.implementedOptionalServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-implemented"
                                               title="Optional server cluster implemented">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.implementedOptionalClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-implemented"
                                               title="Optional client cluster implemented">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}

                            {# Extra Clusters - Beyond Spec #}
                            {% if analysis.extraServer is not empty or analysis.extraClient is not empty %}
                                <div class="gap-cluster-group">
                                    <div class="gap-cluster-group-title">
                                        Extra (Beyond Spec)
                                        <span class="count" style="background: var(--blue-200); color: var(--blue-700);">
                                            {{ analysis.extraServer|length + analysis.extraClient|length }}
                                        </span>
                                    </div>
                                    <div class="gap-cluster-list">
                                        {% for cluster in analysis.extraServer %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-extra"
                                               title="Server cluster not in device type spec">
                                                {{ cluster.name }}
                                            </a>
                                        {% endfor %}
                                        {% for cluster in analysis.extraClient %}
                                            <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster.id)}) }}"
                                               class="gap-cluster-tag gap-cluster-extra"
                                               title="Client cluster not in device type spec">
                                                {{ cluster.name }} (client)
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--gray-500);">
                            {{ analysis.compliance.implementedMandatory }}/{{ analysis.compliance.totalMandatory }} required |
                            {{ analysis.compliance.implementedOptional }}/{{ analysis.compliance.totalOptional }} optional
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {% if frequentlyPairedWith is not empty %}
        <div class="pairing-section">
            <h3>
                Frequently Paired With
                {% if installationCount > 0 %}
                    <span class="installation-stat">
                        Found in {{ installationCount }} installation{{ installationCount != 1 ? 's' : '' }}
                    </span>
                {% endif %}
            </h3>
            <p class="pairing-subtitle">
                These devices are commonly found together in the same smart home setup based on anonymous telemetry data.
            </p>
            <div class="paired-products">
                {% for paired in frequentlyPairedWith %}
                    <a href="{{ path('device_show', {slug: paired.slug}) }}" class="paired-product">
                        <span class="paired-product-name">{{ paired.product_name ?? 'Unknown Product' }}</span>
                        <span class="paired-product-vendor">{{ paired.vendor_name ?? 'Unknown Vendor' }}</span>
                        <div class="pairing-stats">
                            <span class="pairing-stat">
                                <span class="pairing-stat-value">{{ paired.shared_installations }}</span>
                                <span class="pairing-stat-label">shared</span>
                            </span>
                            <span class="pairing-stat">
                                <span class="pairing-stat-value">{{ paired.pairing_strength }}%</span>
                                <span class="pairing-stat-label">of installs</span>
                            </span>
                        </div>
                        <div class="pairing-strength-bar">
                            <div class="pairing-strength-fill" style="width: {{ paired.pairing_strength }}%;"></div>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {% if endpoints is not empty %}
        <div class="section">
            <h3>Endpoints by Version</h3>
            {# Group endpoints by hardware version, then by software version #}
            {% set hwGroups = {} %}
            {% for ep in endpoints %}
                {% set hwKey = ep.hardware_version ?? 'unknown' %}
                {% set swKey = ep.software_version ?? 'unknown' %}
                {# Get current hw group or empty object #}
                {% set currentHwGroup = hwGroups[hwKey] ?? {} %}
                {# Get current sw group or empty array #}
                {% set currentSwGroup = currentHwGroup[swKey] ?? [] %}
                {# Add endpoint to sw group #}
                {% set currentSwGroup = currentSwGroup|merge([ep]) %}
                {# Update hw group with new sw group #}
                {% set currentHwGroup = currentHwGroup|merge({(swKey): currentSwGroup}) %}
                {# Update hwGroups with new hw group #}
                {% set hwGroups = hwGroups|merge({(hwKey): currentHwGroup}) %}
            {% endfor %}

            {% for hwVersion, swGroups in hwGroups %}
                <div class="hardware-group" style="margin-bottom: 2rem;">
                    <h4 style="font-size: 1rem; color: var(--gray-600); margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--gray-200);">
                        Hardware: {{ hwVersion != 'unknown' ? hwVersion : 'N/A' }}
                    </h4>

                    {% set swVersionKeys = swGroups|keys %}

                    {% for swVersion, versionEndpoints in swGroups %}
                        {% set swVersionIndex = loop.index0 %}
                        {# Look at next software version (older, since sorted DESC) within same hardware #}
                        {% set olderSwVersion = not loop.last ? swVersionKeys[swVersionIndex + 1] : null %}

                <div class="version-group">
                    <div class="version-header">
                        <span class="version-label">
                            SW: {{ swVersion != 'unknown' ? swVersion : 'N/A' }}
                            {% if loop.first %}<span class="badge" style="margin-left: 0.5rem; font-size: 0.625rem;">Latest</span>{% endif %}
                        </span>
                        <span class="endpoint-count">{{ versionEndpoints|length }} endpoint{{ versionEndpoints|length != 1 ? 's' : '' }}</span>
                    </div>

                    {% for ep in versionEndpoints %}
                        {# Find matching endpoint in older software version (within same hardware) for diff #}
                        {% set olderEndpoint = null %}
                        {% if olderSwVersion and swGroups[olderSwVersion] is defined %}
                            {% for olderEp in swGroups[olderSwVersion] %}
                                {% if olderEp.endpoint_id == ep.endpoint_id %}
                                    {% set olderEndpoint = olderEp %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}

                        {# Calculate cluster diff (what changed from older version to this version) #}
                        {% set addedServerClusters = [] %}
                        {% set removedServerClusters = [] %}
                        {% set addedClientClusters = [] %}
                        {% set removedClientClusters = [] %}

                        {% if olderEndpoint %}
                            {# Find added server clusters (in current but not in older) #}
                            {% for cluster in ep.server_clusters %}
                                {% if cluster not in olderEndpoint.server_clusters %}
                                    {% set addedServerClusters = addedServerClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                            {# Find removed server clusters (in older but not in current) #}
                            {% for cluster in olderEndpoint.server_clusters %}
                                {% if cluster not in ep.server_clusters %}
                                    {% set removedServerClusters = removedServerClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                            {# Find added client clusters #}
                            {% for cluster in ep.client_clusters %}
                                {% if cluster not in olderEndpoint.client_clusters %}
                                    {% set addedClientClusters = addedClientClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                            {# Find removed client clusters #}
                            {% for cluster in olderEndpoint.client_clusters %}
                                {% if cluster not in ep.client_clusters %}
                                    {% set removedClientClusters = removedClientClusters|merge([cluster]) %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <div class="endpoint">
                            <div class="endpoint-header">
                                <h4>Endpoint {{ ep.endpoint_id }}</h4>
                                {% if ep.has_binding_cluster %}
                                    <span class="badge badge-binding">Has Binding Cluster</span>
                                {% endif %}
                            </div>

                    {% if ep.device_types is not empty %}
                        <div class="device-types">
                            <div class="label">Device Types</div>
                            <div class="tag-list">
                                {% for dt in ep.device_types %}
                                    {# Handle both object format {"id": 256} and plain integer format 256 #}
                                    {% set dtId = dt.id is defined ? dt.id : dt %}
                                    {% set meta = matterRegistry.getDeviceTypeMetadata(dtId) %}
                                    {% set categoryClass = meta ? 'tag-category-' ~ meta.displayCategory|lower : 'tag-primary' %}
                                    <a href="{{ path('stats_device_type_show', {type: dtId}) }}" class="tag {{ categoryClass }}" title="{{ meta.description ?? 'Unknown device type' }}">
                                        <span class="device-icon">{{ _self.deviceIcon(meta.icon ?? 'device') }}</span>
                                        {{ meta.name ?? ('Device Type ' ~ dtId) }}
                                        {% if meta.specVersion is defined and meta.specVersion != '1.0' %}
                                            <span class="spec-badge">{{ meta.specVersion }}</span>
                                        {% endif %}
                                        <span class="tag-id">#{{ dtId }}</span>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if ep.server_clusters is not empty %}
                        <div class="clusters">
                            <div class="label">Server Clusters</div>
                            <div class="tag-list">
                                {% for cluster in ep.server_clusters %}
                                    <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster)}) }}" class="tag">{{ matterRegistry.getClusterName(cluster) }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if ep.client_clusters is not empty %}
                        <div class="clusters">
                            <div class="label">Client Clusters</div>
                            <div class="tag-list">
                                {% for cluster in ep.client_clusters %}
                                    <a href="{{ path('stats_cluster_show', {hexId: '0x%04X'|format(cluster)}) }}" class="tag tag-client">{{ matterRegistry.getClusterName(cluster) }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {# Show diff from previous version #}
                    {% if addedServerClusters|length > 0 or removedServerClusters|length > 0 or addedClientClusters|length > 0 or removedClientClusters|length > 0 %}
                        <div class="version-diff">
                            <div class="diff-title">Changes from previous version:</div>
                            {% if addedServerClusters|length > 0 %}
                                <div>
                                    {% for cluster in addedServerClusters %}
                                        <span class="diff-item diff-added">{{ matterRegistry.getClusterName(cluster) }} (server)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if removedServerClusters|length > 0 %}
                                <div>
                                    {% for cluster in removedServerClusters %}
                                        <span class="diff-item diff-removed">{{ matterRegistry.getClusterName(cluster) }} (server)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if addedClientClusters|length > 0 %}
                                <div>
                                    {% for cluster in addedClientClusters %}
                                        <span class="diff-item diff-added">{{ matterRegistry.getClusterName(cluster) }} (client)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if removedClientClusters|length > 0 %}
                                <div>
                                    {% for cluster in removedClientClusters %}
                                        <span class="diff-item diff-removed">{{ matterRegistry.getClusterName(cluster) }} (client)</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                        </div>
                    {% endfor %}
                </div>
                    {% endfor %}{# end swVersion loop #}
                </div>{# end hardware-group #}
            {% endfor %}{# end hwVersion loop #}
        </div>
    {% endif %}

    {% if versions is not empty %}
        <div class="section">
            <h3>Known Versions</h3>
            <table class="versions-table">
                <thead>
                    <tr>
                        <th>Hardware Version</th>
                        <th>Software Version</th>
                        <th>Count</th>
                        <th>First Seen</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in versions %}
                        <tr>
                            <td>{{ v.hardware_version ?? 'N/A' }}</td>
                            <td>{{ v.software_version ?? 'N/A' }}</td>
                            <td>{{ v.count|number_format }}</td>
                            <td>{{ v.first_seen }}</td>
                            <td>{{ v.last_seen }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <div class="back-link">
        <a href="{{ path('device_index') }}">&laquo; Back to device index</a>
    </div>
{% endblock %}
