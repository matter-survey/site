{#
    Capabilities Component
    Displays human-friendly device capabilities in a visual grid layout.
    Supported capabilities are expandable to show detailed commands and attributes.

    Parameters:
    - capabilities: The capabilities analysis result from CapabilityService
    - deviceScore: The device score (for star rating display)
#}

{% if capabilities and capabilities.byCategory|length > 0 %}
<div class="capabilities-section">
    <div class="capabilities-header">
        <div class="capabilities-title">
            <h3>What This Device Can Do</h3>
            {% if capabilities.deviceCategory %}
                <span class="device-category-badge">{{ capabilities.deviceCategory|capitalize }}</span>
            {% endif %}
        </div>
        <div class="capabilities-summary">
            {% if deviceScore and deviceScore.starRating is defined %}
                <span class="capabilities-rating">
                    {% for i in 1..5 %}
                        {% if i <= deviceScore.starRating|round(0, 'floor') %}
                            <span class="star-filled">&#9733;</span>
                        {% elseif i - 0.5 <= deviceScore.starRating %}
                            <span class="star-half"><span class="star-half-filled">&#9733;</span><span class="star-half-empty">&#9733;</span></span>
                        {% else %}
                            <span class="star-empty">&#9734;</span>
                        {% endif %}
                    {% endfor %}
                </span>
            {% endif %}
            <span class="capabilities-percentage">{{ capabilities.summary.percentage }}% of features</span>
        </div>
    </div>

    <div class="capabilities-grid">
        {% for catKey, category in capabilities.byCategory %}
            {% if category.supported|length > 0 or category.unsupported|length > 0 %}
                <div class="capability-category">
                    <h4 class="category-label">{{ category.label }}</h4>
                    <div class="capability-cards">
                        {# Supported capabilities - expandable if they have details #}
                        {% for cap in category.supported %}
                            {% set hasDetails = cap.details is defined and cap.details is not null and (cap.details.actions|length > 0 or cap.details.statuses|length > 0) %}
                            <div class="capability-card capability-supported{% if hasDetails %} capability-expandable{% endif %}"
                                 title="{{ cap.description }}"
                                 {% if hasDetails %}data-expandable="true"{% endif %}>
                                <div class="capability-summary"{% if hasDetails %} onclick="toggleCapabilityDetails(this)"{% endif %}>
                                    <span class="capability-emoji">{{ cap.emoji }}</span>
                                    <span class="capability-label">{{ cap.label }}</span>
                                    <span class="capability-status">&#10003;</span>
                                    {% if hasDetails %}
                                        <span class="capability-expand-icon">&#9662;</span>
                                    {% endif %}
                                </div>
                                {% if hasDetails %}
                                    <div class="capability-details" style="display: none;">
                                        <div class="capability-cluster-name" title="Matter cluster: {{ cap.details.clusterName }} (ID: {{ cap.details.clusterId }})">
                                            <span class="cluster-badge">{{ cap.details.clusterName }}</span>
                                        </div>

                                        {% if cap.details.actions|length > 0 %}
                                            <div class="capability-actions">
                                                <h5>What you can do:</h5>
                                                <ul>
                                                    {% for action in cap.details.actions %}
                                                        <li title="Command: {{ action.technical }}">
                                                            <span class="action-bullet">&#8226;</span>
                                                            <span class="action-friendly">{{ action.friendly }}</span>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}

                                        {% if cap.details.statuses|length > 0 %}
                                            <div class="capability-statuses">
                                                <h5>Information available:</h5>
                                                <ul>
                                                    {% for status in cap.details.statuses %}
                                                        <li title="Attribute: {{ status.technical }}">
                                                            <span class="status-bullet">&#8226;</span>
                                                            <span class="status-friendly">{{ status.friendly }}</span>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}

                                        {% if cap.details.features|length > 0 %}
                                            <div class="capability-features">
                                                <h5>Enabled features:</h5>
                                                <div class="feature-tags">
                                                    {% for feature in cap.details.features %}
                                                        <span class="feature-tag" title="Feature: {{ feature.name }}">{{ feature.name }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}

                        {# Unsupported capabilities #}
                        {% for cap in category.unsupported %}
                            <div class="capability-card capability-unsupported" title="{{ cap.description }} (not available)">
                                <div class="capability-summary">
                                    <span class="capability-emoji">{{ cap.emoji }}</span>
                                    <span class="capability-label">{{ cap.label }}</span>
                                    <span class="capability-status">&#10005;</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if capabilities.standouts|length > 0 or capabilities.missing|length > 0 %}
        <div class="capabilities-callouts">
            {% if capabilities.standouts|length > 0 %}
                <div class="callout callout-standout">
                    <span class="callout-icon">&#10024;</span>
                    <span class="callout-label">Standout:</span>
                    <span class="callout-text">{{ capabilities.standouts|join(', ') }}</span>
                </div>
            {% endif %}
            {% if capabilities.missing|length > 0 %}
                <div class="callout callout-missing">
                    <span class="callout-icon">&#9888;</span>
                    <span class="callout-label">Not available:</span>
                    <span class="callout-text">{{ capabilities.missing|join(', ') }}</span>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
function toggleCapabilityDetails(element) {
    const card = element.closest('.capability-card');
    const details = card.querySelector('.capability-details');
    const icon = card.querySelector('.capability-expand-icon');

    if (details.style.display === 'none') {
        details.style.display = 'block';
        card.classList.add('expanded');
        if (icon) icon.innerHTML = '&#9652;'; // Up arrow
    } else {
        details.style.display = 'none';
        card.classList.remove('expanded');
        if (icon) icon.innerHTML = '&#9662;'; // Down arrow
    }
}
</script>
{% endif %}
