{#
    Capabilities Component
    Displays human-friendly device capabilities in a table layout.
    Each capability shows: name, Matter spec version, and support status.
    Supported capabilities are expandable to show detailed commands and attributes
    with implementation status (spec vs what device actually implements).

    Parameters:
    - capabilities: The capabilities analysis result from CapabilityService
    - deviceScore: The device score (for star rating display)
#}

{% if capabilities and capabilities.byCategory|length > 0 %}
<div class="capabilities-section">
    <div class="capabilities-header">
        <div class="capabilities-title">
            <h3>What This Device Can Do</h3>
            {% if capabilities.deviceCategory %}
                <span class="device-category-badge">{{ capabilities.deviceCategory|capitalize }}</span>
            {% endif %}
        </div>
        <div class="capabilities-summary">
            {% if deviceScore and deviceScore.starRating is defined %}
                <span class="capabilities-rating">
                    {% for i in 1..5 %}
                        {% if i <= deviceScore.starRating|round(0, 'floor') %}
                            <span class="star-filled">&#9733;</span>
                        {% elseif i - 0.5 <= deviceScore.starRating %}
                            <span class="star-half"><span class="star-half-filled">&#9733;</span><span class="star-half-empty">&#9733;</span></span>
                        {% else %}
                            <span class="star-empty">&#9734;</span>
                        {% endif %}
                    {% endfor %}
                </span>
            {% endif %}
            <span class="capabilities-percentage">{{ capabilities.summary.percentage }}% of features</span>
        </div>
    </div>

    <div class="capabilities-tables">
        {% for catKey, category in capabilities.byCategory %}
            {% if category.supported|length > 0 or category.unsupported|length > 0 %}
                <div class="capability-category">
                    <table class="capability-table">
                        <thead>
                            <tr>
                                <th class="cap-th-name" colspan="3">{{ category.label }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Supported capabilities - expandable if they have details #}
                            {% for cap in category.supported %}
                                {% set hasDetails = cap.details is defined and cap.details is not null and (cap.details.actions|length > 0 or cap.details.statuses|length > 0) %}
                                <tr class="capability-row capability-supported{% if hasDetails %} capability-expandable{% endif %}"
                                    title="{{ cap.description }}"
                                    {% if hasDetails %}onclick="toggleCapabilityRow(this)"{% endif %}>
                                    <td class="cap-td-name">
                                        {% if hasDetails %}
                                            <span class="cap-expand-icon">&#9654;</span>
                                        {% else %}
                                            <span class="cap-expand-placeholder"></span>
                                        {% endif %}
                                        <span class="cap-emoji">{{ cap.emoji }}</span>
                                        <span class="cap-label">{{ cap.label }}</span>
                                    </td>
                                    <td class="cap-td-spec">
                                        {% if cap.specVersion %}
                                            <span class="cap-spec-version">v{{ cap.specVersion }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="cap-td-status cap-status-supported">&#10003;</td>
                                </tr>
                                {% if hasDetails %}
                                    <tr class="capability-details-row" style="display: none;">
                                        <td colspan="3" class="cap-td-details">
                                            <div class="cap-details-content">
                                                <div class="cap-cluster-name" title="Matter cluster: {{ cap.details.clusterName }} (ID: {{ cap.details.clusterId }})">
                                                    <span class="cluster-badge">{{ cap.details.clusterName }}</span>
                                                </div>

                                                {% if cap.details.actions|length > 0 %}
                                                    <div class="cap-detail-section">
                                                        <h5>What you can do:</h5>
                                                        <ul class="cap-detail-list">
                                                            {% for action in cap.details.actions %}
                                                                {% set implClass = action.implemented is same as(true) ? 'cap-implemented' : (action.implemented is same as(false) ? 'cap-not-implemented' : 'cap-unknown') %}
                                                                {% set implIcon = action.implemented is same as(true) ? '&#10003;' : (action.implemented is same as(false) ? '&#10005;' : '&#8226;') %}
                                                                <li class="{{ implClass }}" title="Command: {{ action.technical }}{% if action.optional %} (optional){% endif %}">
                                                                    <span class="cap-impl-icon">{{ implIcon|raw }}</span>
                                                                    <span class="cap-item-text">{{ action.friendly }}</span>
                                                                    {% if action.implemented is same as(false) and action.optional %}
                                                                        <span class="cap-optional-badge">optional</span>
                                                                    {% endif %}
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}

                                                {% if cap.details.statuses|length > 0 %}
                                                    <div class="cap-detail-section">
                                                        <h5>Information available:</h5>
                                                        <ul class="cap-detail-list">
                                                            {% for status in cap.details.statuses %}
                                                                {% set implClass = status.implemented is same as(true) ? 'cap-implemented' : (status.implemented is same as(false) ? 'cap-not-implemented' : 'cap-unknown') %}
                                                                {% set implIcon = status.implemented is same as(true) ? '&#10003;' : (status.implemented is same as(false) ? '&#10005;' : '&#8226;') %}
                                                                <li class="{{ implClass }}" title="Attribute: {{ status.technical }}{% if status.optional %} (optional){% endif %}">
                                                                    <span class="cap-impl-icon">{{ implIcon|raw }}</span>
                                                                    <span class="cap-item-text">{{ status.friendly }}</span>
                                                                    {% if status.implemented is same as(false) and status.optional %}
                                                                        <span class="cap-optional-badge">optional</span>
                                                                    {% endif %}
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}

                                                {% if cap.details.features|length > 0 %}
                                                    <div class="cap-detail-section">
                                                        <h5>Enabled features:</h5>
                                                        <div class="cap-feature-tags">
                                                            {% for feature in cap.details.features %}
                                                                <span class="cap-feature-tag" title="Feature: {{ feature.name }}">{{ feature.name }}</span>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}

                            {# Unsupported capabilities #}
                            {% for cap in category.unsupported %}
                                <tr class="capability-row capability-unsupported" title="{{ cap.description }} (not available)">
                                    <td class="cap-td-name">
                                        <span class="cap-expand-placeholder"></span>
                                        <span class="cap-emoji">{{ cap.emoji }}</span>
                                        <span class="cap-label">{{ cap.label }}</span>
                                    </td>
                                    <td class="cap-td-spec">
                                        {% if cap.specVersion %}
                                            <span class="cap-spec-version">v{{ cap.specVersion }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="cap-td-status cap-status-unsupported">&#10005;</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if capabilities.standouts|length > 0 or capabilities.missing|length > 0 %}
        <div class="capabilities-callouts">
            {% if capabilities.standouts|length > 0 %}
                <div class="callout callout-standout">
                    <span class="callout-icon">&#10024;</span>
                    <span class="callout-label">Standout:</span>
                    <span class="callout-text">{{ capabilities.standouts|join(', ') }}</span>
                </div>
            {% endif %}
            {% if capabilities.missing|length > 0 %}
                <div class="callout callout-missing">
                    <span class="callout-icon">&#9888;</span>
                    <span class="callout-label">Not available:</span>
                    <span class="callout-text">{{ capabilities.missing|join(', ') }}</span>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
function toggleCapabilityRow(row) {
    const detailsRow = row.nextElementSibling;
    if (!detailsRow || !detailsRow.classList.contains('capability-details-row')) return;

    const icon = row.querySelector('.cap-expand-icon');

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        row.classList.add('expanded');
        if (icon) icon.innerHTML = '&#9660;'; // Down arrow (expanded)
    } else {
        detailsRow.style.display = 'none';
        row.classList.remove('expanded');
        if (icon) icon.innerHTML = '&#9654;'; // Right arrow (collapsed)
    }
}
</script>
{% endif %}
